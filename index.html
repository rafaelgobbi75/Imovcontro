<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Imovcontrol â€” GestÃ£o de ComissÃµes</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root {
  --gold:#C9A84C;--gold-l:#F0D882;--gold-d:#8A6020;
  --bg:#07070D;--bg2:#0E0E18;--bg3:#161624;--bg4:#1E1E30;--bg5:#26263C;
  --text:#F2EFE8;--text2:#8E8A7E;--text3:#5A5650;
  --border:rgba(201,168,76,0.18);--border2:rgba(255,255,255,0.06);
  --green:#3ECFB8;--green-d:#1A6B5E;
  --blue:#5B8FD4;--blue-d:#2A4870;
  --red:#E06858;--red-d:#6E2A20;
  --orange:#E09040;--orange-d:#6E4010;
  --purple:#9B7FC6;--purple-d:#4A3068;
  --teal:#40B4C8;
  --r:18px;--r2:12px;--r3:8px;
}
*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}

/* â”€â”€ Noise overlay â”€â”€ */
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");opacity:.4;pointer-events:none;z-index:0;}

/* â”€â”€ Ambient glows â”€â”€ */
.glow-tl{position:fixed;top:-200px;left:-200px;width:600px;height:600px;background:radial-gradient(circle,rgba(201,168,76,0.07) 0%,transparent 70%);pointer-events:none;z-index:0;}
.glow-br{position:fixed;bottom:-200px;right:-200px;width:500px;height:500px;background:radial-gradient(circle,rgba(91,143,212,0.06) 0%,transparent 70%);pointer-events:none;z-index:0;}

.wrap{position:relative;z-index:1;max-width:1600px;margin:0 auto;padding:0 28px 80px;}

/* â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.site-header{
  padding:36px 0 28px;
  display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:20px;
  border-bottom:1px solid var(--border);margin-bottom:40px;
}
.brand{display:flex;align-items:center;gap:14px;}
.brand-icon{
  width:46px;height:46px;border-radius:12px;
  background:linear-gradient(135deg,var(--gold),var(--gold-d));
  display:flex;align-items:center;justify-content:center;font-size:1.3rem;
  box-shadow:0 4px 20px rgba(201,168,76,0.35);
}
.brand h1{font-family:'Cormorant Garamond',serif;font-size:2rem;font-weight:700;letter-spacing:-0.02em;background:linear-gradient(135deg,var(--gold-l),var(--gold),var(--gold-d));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1;}
.brand p{font-size:0.72rem;color:var(--text2);letter-spacing:0.12em;text-transform:uppercase;margin-top:3px;}
.header-right{display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
.hbadge{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r2);padding:12px 18px;text-align:right;}
.hbadge .hl{font-size:0.68rem;color:var(--text2);text-transform:uppercase;letter-spacing:0.1em;}
.hbadge .hv{font-family:'Cormorant Garamond',serif;font-size:1.5rem;font-weight:700;color:var(--gold-l);line-height:1.1;}
.hbadge.alert-badge{border-color:rgba(224,104,88,0.4);background:rgba(224,104,88,0.08);}
.hbadge.alert-badge .hv{color:var(--red);}

/* â•â• NAV TABS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.nav-tabs{display:flex;gap:4px;background:var(--bg3);border:1px solid var(--border2);border-radius:var(--r2);padding:4px;margin-bottom:36px;width:fit-content;}
.nav-tab{padding:9px 20px;border-radius:var(--r3);font-size:0.82rem;font-weight:500;color:var(--text2);cursor:pointer;transition:all 0.2s;border:none;background:none;font-family:'Inter',sans-serif;display:flex;align-items:center;gap:7px;}
.nav-tab.active{background:var(--bg5);color:var(--text);box-shadow:0 2px 8px rgba(0,0,0,0.3);}
.nav-tab:hover:not(.active){color:var(--text);background:var(--bg4);}

.tab-content{display:none;}
.tab-content.active{display:block;}

/* â•â• SECTION TITLE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sec-title{font-family:'Cormorant Garamond',serif;font-size:1.35rem;font-weight:700;color:var(--gold-l);display:flex;align-items:center;gap:10px;margin-bottom:24px;}
.sec-title::before{content:'';width:3px;height:22px;background:linear-gradient(180deg,var(--gold),var(--gold-d));border-radius:2px;display:inline-block;flex-shrink:0;}

/* â•â• STAT CARDS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));gap:14px;margin-bottom:28px;}
.scard{
  background:var(--bg2);border:1px solid var(--border2);border-radius:var(--r);padding:22px 20px;
  position:relative;overflow:hidden;cursor:default;transition:transform .2s,border-color .2s,box-shadow .2s;
}
.scard:hover{transform:translateY(-3px);border-color:var(--border);box-shadow:0 12px 40px rgba(0,0,0,0.3);}
.scard::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.scard.c-gold::before{background:linear-gradient(90deg,var(--gold),var(--gold-l));}
.scard.c-green::before{background:linear-gradient(90deg,var(--green),#7EDDD7);}
.scard.c-blue::before{background:linear-gradient(90deg,var(--blue),#8FABD4);}
.scard.c-purple::before{background:linear-gradient(90deg,var(--purple),#BCA4E0);}
.scard.c-orange::before{background:linear-gradient(90deg,var(--orange),#F0C060);}
.scard.c-red::before{background:linear-gradient(90deg,var(--red),#F09080);}
.scard .sl{font-size:0.68rem;color:var(--text2);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:10px;font-weight:500;}
.scard .sv{font-family:'Cormorant Garamond',serif;font-size:1.9rem;font-weight:700;line-height:1;}
.scard.c-gold .sv{color:var(--gold-l);}
.scard.c-green .sv{color:var(--green);}
.scard.c-blue .sv{color:var(--blue);}
.scard.c-purple .sv{color:var(--purple);}
.scard.c-orange .sv{color:var(--orange);}
.scard.c-red .sv{color:var(--red);}
.scard .ss{font-size:0.74rem;color:var(--text2);margin-top:6px;}
.scard .sicon{position:absolute;right:16px;top:50%;transform:translateY(-50%);font-size:2rem;opacity:0.1;}

/* â•â• PANORÃ‚MICA / CHARTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.charts-grid{display:grid;grid-template-columns:1fr 1fr 1.4fr;gap:20px;margin-bottom:28px;}
@media(max-width:1100px){.charts-grid{grid-template-columns:1fr 1fr;}}
@media(max-width:700px){.charts-grid{grid-template-columns:1fr;}}

.chart-card{background:var(--bg2);border:1px solid var(--border2);border-radius:var(--r);padding:24px;position:relative;overflow:hidden;}
.chart-card::after{content:'';position:absolute;top:-80px;right:-80px;width:180px;height:180px;border-radius:50%;background:radial-gradient(circle,rgba(201,168,76,0.05) 0%,transparent 70%);pointer-events:none;}
.chart-title{font-size:0.72rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--text2);margin-bottom:20px;font-weight:500;}
.chart-wrap{position:relative;height:200px;display:flex;align-items:center;justify-content:center;}
.chart-wrap canvas{max-height:200px;}

/* Donut center label */
.donut-center{position:absolute;text-align:center;pointer-events:none;}
.donut-center .dc-val{font-family:'Cormorant Garamond',serif;font-size:1.6rem;font-weight:700;color:var(--text);line-height:1;}
.donut-center .dc-lbl{font-size:0.65rem;color:var(--text2);text-transform:uppercase;letter-spacing:0.08em;margin-top:2px;}

/* Legend pills */
.legend-row{display:flex;flex-wrap:wrap;gap:8px;margin-top:16px;}
.lpill{display:flex;align-items:center;gap:6px;font-size:0.75rem;color:var(--text2);}
.lpill-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}

/* % bars */
.pct-bars{display:flex;flex-direction:column;gap:12px;margin-top:8px;}
.pbar-row{display:flex;flex-direction:column;gap:5px;}
.pbar-top{display:flex;justify-content:space-between;font-size:0.75rem;}
.pbar-lbl{color:var(--text2);}
.pbar-pct{font-weight:600;}
.pbar-track{height:6px;background:var(--bg5);border-radius:3px;overflow:hidden;}
.pbar-fill{height:100%;border-radius:3px;transition:width 0.8s cubic-bezier(0.4,0,0.2,1);}

/* â•â• PROJEÃ‡ÃƒO TIMELINE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.proj-section{background:var(--bg2);border:1px solid var(--border2);border-radius:var(--r);padding:28px;margin-bottom:28px;}
.proj-scroll{display:flex;gap:12px;overflow-x:auto;padding-bottom:8px;}
.proj-scroll::-webkit-scrollbar{height:4px;}
.proj-scroll::-webkit-scrollbar-track{background:var(--bg3);}
.proj-scroll::-webkit-scrollbar-thumb{background:var(--bg5);border-radius:2px;}
.pmonth{
  flex-shrink:0;min-width:150px;background:var(--bg3);border:1px solid var(--border2);
  border-radius:var(--r2);padding:18px;transition:all .2s;
}
.pmonth:hover{border-color:var(--border);transform:translateY(-2px);}
.pmonth.pnext{border-color:rgba(201,168,76,0.4);background:rgba(201,168,76,0.07);}
.pmonth.ppast{opacity:0.45;}
.pm-label{font-size:0.68rem;color:var(--text2);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:8px;}
.pm-value{font-family:'Cormorant Garamond',serif;font-size:1.4rem;font-weight:700;color:var(--text);}
.pmonth.pnext .pm-value{color:var(--gold-l);}
.pm-tag{display:inline-block;margin-top:6px;font-size:0.65rem;padding:3px 8px;border-radius:4px;}
.pm-tag.next{background:rgba(201,168,76,0.15);color:var(--gold-l);}
.pm-tag.past{background:rgba(62,207,184,0.12);color:var(--green);}
.pm-tag.future{background:rgba(91,143,212,0.12);color:var(--blue);}

/* â•â• BOLETO ALERTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.alert-section{background:var(--bg2);border:1px solid rgba(224,104,88,0.2);border-radius:var(--r);padding:28px;margin-bottom:28px;}
.alert-list{display:flex;flex-direction:column;gap:10px;}
.alert-item{
  display:flex;align-items:center;gap:14px;padding:14px 18px;border-radius:var(--r2);
  background:var(--bg3);border:1px solid var(--border2);transition:all .2s;
}
.alert-item:hover{border-color:rgba(224,104,88,0.3);}
.alert-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.alert-dot.red{background:var(--red);box-shadow:0 0 8px rgba(224,104,88,0.6);}
.alert-dot.orange{background:var(--orange);box-shadow:0 0 8px rgba(224,144,64,0.6);}
.alert-dot.yellow{background:#D4B840;box-shadow:0 0 8px rgba(212,184,64,0.5);}
.alert-info{flex:1;}
.alert-name{font-size:0.85rem;font-weight:600;color:var(--text);}
.alert-detail{font-size:0.75rem;color:var(--text2);margin-top:2px;}
.alert-days{font-family:'Cormorant Garamond',serif;font-size:1.1rem;font-weight:700;text-align:right;white-space:nowrap;}
.alert-days.red{color:var(--red);}
.alert-days.orange{color:var(--orange);}
.alert-days.yellow{color:#D4B840;}
.no-alerts{text-align:center;padding:40px;color:var(--text2);font-size:0.85rem;}
.no-alerts .na-icon{font-size:2.5rem;opacity:0.3;margin-bottom:10px;}

/* â•â• FORM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.form-card{background:var(--bg2);border:1px solid var(--border2);border-radius:var(--r);padding:32px;margin-bottom:28px;}
.form-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:16px;margin-bottom:20px;}
.field{display:flex;flex-direction:column;gap:7px;}
.field label{font-size:0.7rem;color:var(--text2);text-transform:uppercase;letter-spacing:0.1em;font-weight:500;}
.field input,.field select{
  background:var(--bg3);border:1px solid rgba(255,255,255,0.08);border-radius:var(--r3);
  padding:11px 14px;color:var(--text);font-family:'Inter',sans-serif;font-size:0.875rem;
  outline:none;transition:border-color .2s,box-shadow .2s;width:100%;
}
.field input:focus,.field select:focus{border-color:var(--gold);box-shadow:0 0 0 3px rgba(201,168,76,0.1);}
.field input::placeholder{color:var(--text3);}
.field select option{background:var(--bg3);}
.field.hidden{display:none;}

.sim-box{background:var(--bg3);border:1px solid var(--border2);border-radius:var(--r2);padding:16px 20px;margin-bottom:16px;}
.sim-box h4{font-size:0.68rem;color:var(--text2);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:12px;}
.sim-chips{display:flex;flex-wrap:wrap;gap:8px;align-items:center;}
.chip{padding:5px 12px;border-radius:6px;font-size:0.75rem;border:1px solid rgba(255,255,255,0.07);color:var(--text2);background:var(--bg4);}
.chip.next{border-color:var(--gold);background:rgba(201,168,76,0.12);color:var(--gold-l);}
.chip.future{color:var(--text2);}

.rules-box{background:rgba(201,168,76,0.04);border:1px solid rgba(201,168,76,0.12);border-radius:var(--r2);padding:14px 18px;font-size:0.78rem;color:var(--text2);line-height:1.75;}
.rules-box strong{color:var(--gold-l);}
#gatilho-info{font-size:0.8rem;line-height:1.65;border-radius:var(--r3);}

.btn-reg{
  background:linear-gradient(135deg,var(--gold),var(--gold-d));border:none;border-radius:var(--r2);
  padding:13px 28px;color:#0A0A0F;font-family:'Inter',sans-serif;font-size:0.875rem;font-weight:600;
  cursor:pointer;letter-spacing:0.03em;transition:transform .15s,box-shadow .15s;
  display:inline-flex;align-items:center;gap:8px;margin-top:16px;
}
.btn-reg:hover{transform:translateY(-2px);box-shadow:0 8px 28px rgba(201,168,76,0.35);}
.btn-reg:active{transform:translateY(0);}

/* â•â• TABLE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.table-card{background:var(--bg2);border:1px solid var(--border2);border-radius:var(--r);padding:28px;}
.table-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px;}
.filter-row{display:flex;gap:6px;flex-wrap:wrap;}
.fbtn{background:var(--bg3);border:1px solid rgba(255,255,255,0.07);border-radius:6px;padding:6px 14px;color:var(--text2);font-family:'Inter',sans-serif;font-size:0.78rem;cursor:pointer;transition:all .2s;}
.fbtn.active,.fbtn:hover{border-color:var(--gold);color:var(--gold-l);background:rgba(201,168,76,0.08);}
.search-input{background:var(--bg3);border:1px solid rgba(255,255,255,0.07);border-radius:8px;padding:8px 14px;color:var(--text);font-family:'Inter',sans-serif;font-size:0.8rem;outline:none;width:200px;}
.search-input:focus{border-color:var(--gold);}
.search-input::placeholder{color:var(--text3);}

.twrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;min-width:1050px;}
thead th{font-size:0.67rem;text-transform:uppercase;letter-spacing:0.1em;color:var(--text2);padding:10px 14px;text-align:left;border-bottom:1px solid var(--border2);font-weight:500;white-space:nowrap;}
tbody tr{border-bottom:1px solid rgba(255,255,255,0.03);transition:background .15s;}
tbody tr:hover{background:rgba(201,168,76,0.03);}
tbody td{padding:13px 14px;font-size:0.82rem;color:var(--text);vertical-align:middle;}

.badge{display:inline-flex;align-items:center;gap:4px;padding:4px 9px;border-radius:5px;font-size:0.68rem;font-weight:600;letter-spacing:0.03em;white-space:nowrap;}
.b-pix{background:rgba(62,207,184,0.12);color:var(--green);border:1px solid rgba(62,207,184,0.25);}
.b-cred{background:rgba(91,143,212,0.12);color:var(--blue);border:1px solid rgba(91,143,212,0.25);}
.b-bol{background:rgba(224,144,64,0.12);color:var(--orange);border:1px solid rgba(224,144,64,0.25);}
.b-gd{background:rgba(201,168,76,0.12);color:var(--gold-l);border:1px solid rgba(201,168,76,0.25);}
.b-hs{background:rgba(155,127,198,0.12);color:var(--purple);border:1px solid rgba(155,127,198,0.25);}
.b-sup{background:rgba(224,104,88,0.12);color:var(--red);border:1px solid rgba(224,104,88,0.25);}
.b-venc{background:rgba(224,104,88,0.15);color:var(--red);border:1px solid rgba(224,104,88,0.3);animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.6;}}

.cv{color:var(--gold-l);font-weight:600;font-family:'Cormorant Garamond',serif;font-size:0.95rem;}
.cv-green{color:var(--green);font-weight:600;font-family:'Cormorant Garamond',serif;font-size:0.95rem;}

.del-btn{background:none;border:1px solid rgba(224,104,88,0.2);border-radius:6px;color:var(--red);padding:5px 11px;cursor:pointer;font-size:0.75rem;transition:all .15s;font-family:'Inter',sans-serif;}
.del-btn:hover{background:rgba(224,104,88,0.12);border-color:var(--red);}
.edit-btn{background:none;border:1px solid rgba(91,143,212,0.2);border-radius:6px;color:var(--blue);padding:5px 11px;cursor:pointer;font-size:0.75rem;transition:all .15s;font-family:'Inter',sans-serif;margin-right:4px;}
.edit-btn:hover{background:rgba(91,143,212,0.12);border-color:var(--blue);}
.action-btns{display:flex;gap:4px;align-items:center;}

/* â•â• EDIT OVERLAY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.edit-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:9100;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s;backdrop-filter:blur(6px);}
.edit-overlay.show{opacity:1;pointer-events:all;}
.edit-box{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);padding:32px;max-width:700px;width:95%;max-height:90vh;overflow-y:auto;transform:scale(.95) translateY(20px);transition:transform .25s cubic-bezier(.175,.885,.32,1.275);}
.edit-overlay.show .edit-box{transform:scale(1) translateY(0);}
.edit-box::-webkit-scrollbar{width:4px;}
.edit-box::-webkit-scrollbar-thumb{background:var(--bg5);border-radius:2px;}

/* â•â• COMISSOES FINALIZADAS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.fin-card{background:var(--bg2);border:1px solid rgba(62,207,184,0.2);border-radius:var(--r);padding:20px;position:relative;overflow:hidden;}
.fin-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--green),#7EDDD7);}
.fin-badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:5px;font-size:0.68rem;font-weight:600;background:rgba(62,207,184,0.12);color:var(--green);border:1px solid rgba(62,207,184,0.25);}

/* â•â• MONTH SALES TRACKER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.month-sales-card{background:var(--bg2);border:1px solid var(--border2);border-radius:var(--r);padding:24px;margin-bottom:28px;}
.month-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;margin-top:16px;}
.month-cell{background:var(--bg3);border:1px solid var(--border2);border-radius:var(--r2);padding:14px;text-align:center;transition:all .2s;cursor:default;}
.month-cell:hover{border-color:var(--border);transform:translateY(-2px);}
.month-cell.cur-month{border-color:rgba(201,168,76,0.4);background:rgba(201,168,76,0.07);}
.month-cell .mc-name{font-size:0.65rem;color:var(--text2);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:6px;}
.month-cell .mc-val{font-family:'Cormorant Garamond',serif;font-size:1.2rem;font-weight:700;color:var(--text);}
.month-cell.cur-month .mc-val{color:var(--gold-l);}
.month-cell .mc-n{font-size:0.7rem;color:var(--text3);margin-top:4px;}

.empty{text-align:center;padding:60px 20px;color:var(--text2);}
.empty .ei{font-size:2.8rem;margin-bottom:14px;opacity:0.3;}
.empty p{font-size:0.85rem;line-height:1.6;}

/* â•â• MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:9000;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s;backdrop-filter:blur(4px);}
.overlay.show{opacity:1;pointer-events:all;}
.mbox{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);padding:32px;max-width:380px;width:90%;text-align:center;transform:scale(.9) translateY(10px);transition:transform .25s cubic-bezier(.175,.885,.32,1.275);}
.overlay.show .mbox{transform:scale(1) translateY(0);}
.mbox h3{font-family:'Cormorant Garamond',serif;font-size:1.3rem;color:var(--text);margin-bottom:10px;}
.mbox p{color:var(--text2);font-size:0.82rem;line-height:1.6;margin-bottom:24px;}
.mbtns{display:flex;gap:10px;justify-content:center;}
.btn-cancel{background:var(--bg4);border:1px solid var(--border2);border-radius:var(--r3);padding:10px 22px;color:var(--text2);font-family:'Inter',sans-serif;font-size:0.82rem;cursor:pointer;transition:all .15s;}
.btn-cancel:hover{color:var(--text);border-color:rgba(255,255,255,0.15);}
.btn-del{background:linear-gradient(135deg,var(--red),#B04030);border:none;border-radius:var(--r3);padding:10px 22px;color:#fff;font-family:'Inter',sans-serif;font-size:0.82rem;font-weight:600;cursor:pointer;transition:all .15s;}
.btn-del:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(224,104,88,0.4);}

/* â•â• TOAST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toast{position:fixed;bottom:28px;right:28px;background:var(--bg3);border:1px solid var(--gold);border-radius:var(--r2);padding:13px 18px;color:var(--gold-l);font-size:0.82rem;font-weight:500;z-index:9999;transform:translateY(60px);opacity:0;transition:all .3s cubic-bezier(.175,.885,.32,1.275);box-shadow:0 12px 40px rgba(0,0,0,0.4);pointer-events:none;}
.toast.show{transform:translateY(0);opacity:1;}
.toast.err{border-color:var(--red);color:var(--red);}

/* â•â• CONFERÃŠNCIA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.conf-nav-btn{background:var(--bg3);border:1px solid var(--border2);border-radius:8px;color:var(--text2);width:34px;height:34px;cursor:pointer;font-size:1.1rem;display:flex;align-items:center;justify-content:center;transition:all .15s;font-family:'Inter',sans-serif;}
.conf-nav-btn:hover{border-color:var(--gold);color:var(--gold-l);}
.conf-mes-display{font-family:'Cormorant Garamond',serif;font-size:1.3rem;font-weight:700;color:var(--gold-l);min-width:180px;text-align:center;background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:6px 18px;}

.conf-card{background:var(--bg2);border:1px solid var(--border2);border-radius:var(--r);padding:22px;transition:border-color .2s,box-shadow .2s;position:relative;overflow:hidden;}
.conf-card:hover{border-color:var(--border);box-shadow:0 8px 32px rgba(0,0,0,0.25);}
.conf-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;}
.conf-card.st-ativo::before{background:linear-gradient(90deg,var(--green),#7EDDD7);}
.conf-card.st-inadimplente::before{background:linear-gradient(90deg,var(--red),#F09080);}
.conf-card.st-cancelado::before{background:linear-gradient(90deg,var(--text3),var(--text2));}
.conf-card.st-inadimplente{border-color:rgba(224,104,88,0.25);background:rgba(224,104,88,0.03);}
.conf-card.st-cancelado{border-color:rgba(90,86,80,0.3);opacity:0.6;}

.conf-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px;gap:10px;}
.conf-cliente{font-weight:600;font-size:0.9rem;color:var(--text);}
.conf-emp{font-size:0.72rem;color:var(--text2);margin-top:2px;}
.conf-com{font-family:'Cormorant Garamond',serif;font-size:1.6rem;font-weight:700;color:var(--gold-l);text-align:right;white-space:nowrap;}
.conf-com-label{font-size:0.65rem;color:var(--text2);text-align:right;text-transform:uppercase;letter-spacing:0.08em;}

.conf-row{display:flex;justify-content:space-between;font-size:0.78rem;color:var(--text2);margin-bottom:6px;}
.conf-row span:last-child{color:var(--text);font-weight:500;}

.conf-divider{border:none;border-top:1px solid var(--border2);margin:12px 0;}

.status-select-wrap{display:flex;gap:8px;align-items:center;margin-top:14px;}
.status-select-wrap label{font-size:0.7rem;color:var(--text2);text-transform:uppercase;letter-spacing:0.08em;white-space:nowrap;}
.status-sel{flex:1;background:var(--bg3);border:1px solid rgba(255,255,255,0.08);border-radius:8px;padding:8px 12px;color:var(--text);font-family:'Inter',sans-serif;font-size:0.8rem;outline:none;cursor:pointer;transition:border-color .2s;}
.status-sel:focus{border-color:var(--gold);}
.status-sel option{background:var(--bg3);}
.s-badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:5px;font-size:0.68rem;font-weight:600;letter-spacing:0.03em;}
.s-ativo{background:rgba(62,207,184,0.12);color:var(--green);border:1px solid rgba(62,207,184,0.25);}
.s-inadimplente{background:rgba(224,104,88,0.12);color:var(--red);border:1px solid rgba(224,104,88,0.3);}
.s-cancelado{background:rgba(90,86,80,0.12);color:var(--text2);border:1px solid rgba(90,86,80,0.25);}

.conf-tipo-chip{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:4px;font-size:0.67rem;font-weight:600;margin-bottom:2px;}

/* nota de observaÃ§Ã£o */
.conf-nota{width:100%;background:var(--bg3);border:1px solid rgba(255,255,255,0.07);border-radius:8px;padding:8px 12px;color:var(--text);font-family:'Inter',sans-serif;font-size:0.78rem;resize:none;outline:none;margin-top:8px;transition:border-color .2s;}
.conf-nota:focus{border-color:var(--gold);}
.conf-nota::placeholder{color:var(--text3);}

@media(max-width:640px){
  .conf-cards-grid{grid-template-columns:1fr !important;}
}
::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:var(--bg2);}
::-webkit-scrollbar-thumb{background:var(--bg5);border-radius:3px;}
::-webkit-scrollbar-thumb:hover{background:var(--gold-d);}

@media(max-width:640px){
  .brand h1{font-size:1.6rem;}
  .form-grid{grid-template-columns:1fr;}
  .nav-tabs{width:100%;overflow-x:auto;}
}
</style>
</head>
<body>
<div class="glow-tl"></div>
<div class="glow-br"></div>

<div class="wrap">

<!-- â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<header class="site-header">
  <div class="brand">
    <div class="brand-icon">ğŸ’</div>
    <div>
      <h1>Imovcontrol</h1>
      <p>GestÃ£o de ComissÃµes &amp; Recebimentos</p>
    </div>
  </div>
  <div class="header-right">
    <div class="hbadge alert-badge" id="hb-alert" style="display:none">
      <div class="hl">âš  Boletos Vencendo</div>
      <div class="hv" id="hb-alert-count">0</div>
    </div>
    <div class="hbadge">
      <div class="hl">PrÃ³ximo MÃªs</div>
      <div class="hv" id="hb-prox">R$ 0,00</div>
    </div>
    <div class="hbadge">
      <div class="hl">Total ComissÃµes</div>
      <div class="hv" id="hb-total">R$ 0,00</div>
    </div>
    <button onclick="showConfig()" title="ConfiguraÃ§Ãµes do banco" style="background:var(--bg3);border:1px solid var(--border2);border-radius:10px;width:40px;height:40px;color:var(--text2);font-size:1.1rem;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;" onmouseover="this.style.borderColor='var(--gold)';this.style.color='var(--gold-l)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.06)';this.style.color='var(--text2)'">âš™ï¸</button>
  </div>
</header>

<!-- â•â• TABS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<nav class="nav-tabs">
  <button class="nav-tab active" onclick="switchTab('Resumo',this)">ğŸ“Š Resumo</button>
  <button class="nav-tab" onclick="switchTab('nova',this)">ï¼‹ Nova Venda</button>
  <button class="nav-tab" onclick="switchTab('vendas',this)">ğŸ“‹ Vendas</button>
  <button class="nav-tab" onclick="switchTab('conferencia',this)" id="tab-conferencia-btn">âœ… ConferÃªncia</button>
  <button class="nav-tab" onclick="switchTab('finalizadas',this)" id="tab-finalizadas-btn">ğŸ† Finalizadas</button>
  <button class="nav-tab" onclick="switchTab('boletos',this)" id="tab-boletos">ğŸ”” Boletos</button>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TAB: DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-content active" id="tab-dashboard">

  <!-- Stats -->
  <div class="stats-row" id="stats-row">
    <div class="scard c-gold"><div class="sl">Total ComissÃµes</div><div class="sv" id="s-total">R$ 0</div><div class="ss" id="s-vendas">0 vendas</div><div class="sicon">ğŸ’°</div></div>
    <div class="scard c-green"><div class="sl">PrÃ³ximo MÃªs</div><div class="sv" id="s-prox">R$ 0</div><div class="ss" id="s-prox-l">â€”</div><div class="sicon">ğŸ“…</div></div>
    <div class="scard c-blue"><div class="sl">A Receber</div><div class="sv" id="s-fut">R$ 0</div><div class="ss">Parcelas futuras</div><div class="sicon">â³</div></div>
    <div class="scard c-purple"><div class="sl">JÃ¡ Recebido</div><div class="sv" id="s-rec">R$ 0</div><div class="ss">Parcelas passadas</div><div class="sicon">âœ…</div></div>
    <div class="scard c-orange"><div class="sl">Volume Vendido</div><div class="sv" id="s-vol">R$ 0</div><div class="ss" id="s-vol-l">Valor bruto</div><div class="sicon">ğŸ“ˆ</div></div>
    <div class="scard c-red"><div class="sl">Boletos Ativos</div><div class="sv" id="s-bol">0</div><div class="ss" id="s-bol-l">pendentes</div><div class="sicon">ğŸ“„</div></div>
  </div>

  <!-- Vendas por mÃªs -->
  <div class="month-sales-card">
    <div class="sec-title" style="margin-bottom:4px">ğŸ“… Quanto Vendi por MÃªs</div>
    <div style="font-size:0.75rem;color:var(--text2);margin-bottom:4px">Volume bruto de vendas cadastradas por mÃªs â€” atualizado automaticamente</div>
    <div class="month-grid" id="month-sales-grid"></div>
  </div>

  <!-- Charts row -->
  <div class="charts-grid">

    <!-- Donut: forma de pagamento -->
    <div class="chart-card">
      <div class="chart-title">ğŸ¥§ DistribuiÃ§Ã£o por Forma de Pagamento</div>
      <div class="chart-wrap">
        <canvas id="chart-donut"></canvas>
        <div class="donut-center" id="donut-center">
          <div class="dc-val" id="dc-total">0</div>
          <div class="dc-lbl">vendas</div>
        </div>
      </div>
      <div class="legend-row" id="legend-pag"></div>
    </div>

    <!-- Donut: empreendimentos -->
    <div class="chart-card">
      <div class="chart-title">ğŸ¢ Vendas por Empreendimento</div>
      <div class="chart-wrap">
        <canvas id="chart-emp"></canvas>
        <div class="donut-center" id="donut-center2">
          <div class="dc-val" id="dc-vol">R$0</div>
          <div class="dc-lbl">em vendas</div>
        </div>
      </div>
      <div class="legend-row" id="legend-emp"></div>
    </div>

    <!-- Bar: recebimentos por mÃªs -->
    <div class="chart-card" style="grid-column: span 1;">
      <div class="chart-title">ğŸ“Š Recebimentos por MÃªs</div>
      <div class="chart-wrap" style="height:220px">
        <canvas id="chart-bar"></canvas>
      </div>
    </div>

  </div>

  <!-- % PanorÃ¢mica -->
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:28px;" id="pct-grid">

    <div class="chart-card">
      <div class="chart-title">ğŸ“ ParticipaÃ§Ã£o por Forma de Pagamento</div>
      <div class="pct-bars" id="pct-pag"></div>
    </div>

    <div class="chart-card">
      <div class="chart-title">ğŸ¢ ParticipaÃ§Ã£o por Empreendimento</div>
      <div class="pct-bars" id="pct-emp"></div>
    </div>

  </div>

  <!-- ProjeÃ§Ã£o timeline -->
  <div class="proj-section">
    <div class="sec-title">Linha do Tempo de Recebimentos</div>
    <div class="proj-scroll" id="proj-timeline"></div>
  </div>

</div><!-- /tab-dashboard -->


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TAB: NOVA VENDA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-content" id="tab-nova">
  <div class="form-card">
    <div class="sec-title">Cadastrar Nova Venda</div>

    <div class="form-grid">
      <div class="field"><label>Data da Venda</label><input type="date" id="f-data"></div>
      <div class="field"><label>Nome do Cliente</label><input type="text" id="f-cliente" placeholder="JoÃ£o da Silva"></div>
      <div class="field"><label>Localizador</label><input type="text" id="f-loc" placeholder="LOC-00123"></div>
      <div class="field"><label>Liner ResponsÃ¡vel</label><input type="text" id="f-liner" placeholder="Carlos Mendes"></div>
      <div class="field">
        <label>Empreendimento</label>
        <select id="f-emp">
          <option value="">Selecione...</option>
          <option>Golden Dolphin Grande Hotel</option>
          <option>Hot Springs</option>
          <option>Supreme</option>
        </select>
      </div>
      <div class="field"><label>Valor da Venda (R$)</label><input type="number" id="f-valor" placeholder="0,00" min="0" step="0.01" oninput="onValorChange()"></div>
      <div class="field"><label>Valor da Entrada (R$)</label><input type="number" id="f-entrada" placeholder="0,00" min="0" step="0.01" oninput="renderSim();atualizarGatilho()"></div>
      <div class="field">
        <label>Forma da Entrada</label>
        <select id="f-forma-entrada" onchange="onFormaEntradaChange()">
          <option value="">Selecione...</option>
          <option value="pix">Pix</option>
          <option value="debito">DÃ©bito</option>
          <option value="credito">CrÃ©dito</option>
          <option value="boleto">Boleto</option>
        </select>
      </div>
      <div class="field hidden" id="ff-venc-entrada">
        <label>Vencimento da Entrada (Boleto)</label>
        <input type="date" id="f-venc-entrada" onchange="renderSim()">
      </div>
      <div class="field">
        <label>Forma de Pagamento (Saldo)</label>
        <select id="f-pag" onchange="onPagChange()">
          <option value="">Selecione...</option>
          <option value="pix">Pix / DÃ©bito</option>
          <option value="credito">CrÃ©dito</option>
          <option value="boleto">Boleto (Livre)</option>
        </select>
      </div>
      <div class="field hidden" id="ff-parc">
        <label>NÂº de Parcelas (CrÃ©dito)</label>
        <select id="f-parc" onchange="renderSim()">
          <option value="1">1x</option><option value="2">2x</option><option value="3">3x</option>
          <option value="4">4x</option><option value="5">5x</option><option value="6">6x</option>
          <option value="7">7x</option><option value="8">8x</option><option value="9">9x</option>
          <option value="10">10x</option>
        </select>
      </div>
      <div class="field hidden" id="ff-nboletos">
        <label>NÂº de Boletos Remanescentes</label>
        <select id="f-nboletos" onchange="gerarCamposBoletos()">
          <option value="1">1 boleto</option><option value="2">2 boletos</option>
          <option value="3">3 boletos</option><option value="4">4 boletos</option>
          <option value="5">5 boletos</option><option value="6">6 boletos</option>
          <option value="7">7 boletos</option>
        </select>
      </div>
    </div>

    <!-- Boletos com valores individuais (gerados dinamicamente) -->
    <div id="ff-boletos-datas" style="display:none; margin-bottom:16px;">
      <div style="font-size:0.7rem;color:var(--text2);text-transform:uppercase;letter-spacing:0.1em;font-weight:500;margin-bottom:6px;">ğŸ“… Vencimentos e Valores dos Boletos Remanescentes</div>
      <div style="font-size:0.75rem;color:var(--text3);margin-bottom:10px;">ğŸ’¡ Informe vencimento e valor individual de cada boleto â€” a soma deve cobrir o saldo. O 6% da negociaÃ§Ã£o Ã© totalizdo entre entrada + boletos.</div>
      <div id="boletos-datas-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;"></div>
    </div>

    <div class="sim-box" id="sim-box" style="display:none">
      <h4>ğŸ“† SimulaÃ§Ã£o de Recebimento da ComissÃ£o</h4>
      <div class="sim-chips" id="sim-chips"></div>
    </div>

    <button class="btn-reg" onclick="addVenda()">ï¼‹ Registrar Venda</button>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TAB: VENDAS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-content" id="tab-vendas">
  <div class="table-card">
    <div class="table-top">
      <div class="sec-title" style="margin-bottom:0">Vendas Cadastradas</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
        <input class="search-input" id="search" placeholder="ğŸ” Buscar cliente..." oninput="renderTable()">
        <div class="filter-row">
          <button class="fbtn active" onclick="setFilter('todos',this)">Todos</button>
          <button class="fbtn" onclick="setFilter('pix',this)">Pix</button>
          <button class="fbtn" onclick="setFilter('credito',this)">CrÃ©dito</button>
          <button class="fbtn" onclick="setFilter('boleto',this)">Boleto</button>
        </div>
      </div>
    </div>
    <div class="twrap">
      <table>
        <thead>
          <tr>
            <th>Data</th><th>Cliente</th><th>Localizador</th><th>Liner</th>
            <th>Empreendimento</th><th>Valor Venda</th><th>Entrada</th>
            <th>ComissÃ£o</th><th>Saldo</th><th>Venc. Boleto</th>
            <th>PrÃ³x. MÃªs</th><th>Status</th><th></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TAB: CONFERÃŠNCIA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-content" id="tab-conferencia">

  <!-- Seletor de mÃªs -->
  <div style="margin-bottom:20px;">
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:14px;">
      <div>
        <div class="sec-title" style="margin-bottom:4px">ConferÃªncia de ComissÃµes</div>
        <div style="font-size:0.78rem;color:var(--text2)">ComissÃµes previstas para o mÃªs selecionado â€” atualize o status de cada venda</div>
      </div>
      <input class="search-input" id="conf-search" placeholder="ğŸ” Buscar nome ou localizador..." oninput="renderConferencia()" style="width:240px;">
    </div>
    <div style="display:flex;align-items:center;gap:8px;">
      <button class="conf-nav-btn" onclick="navMes(-1)">â€¹</button>
      <div class="conf-mes-display" id="conf-mes-label" onclick="abrirSeletorMes()" style="cursor:pointer;user-select:none;" title="Clique para selecionar o mÃªs">â€”</div>
      <button class="conf-nav-btn" onclick="navMes(1)">â€º</button>
    </div>
  </div>

  <!-- Modal seletor de mÃªs -->
  <div id="mes-picker-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9500;align-items:center;justify-content:center;backdrop-filter:blur(4px);" onclick="fecharSeletorMes(event)">
    <div style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);padding:28px;max-width:360px;width:92%;box-shadow:0 24px 60px rgba(0,0,0,0.5);" onclick="event.stopPropagation()">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
        <div style="font-family:'Cormorant Garamond',serif;font-size:1.2rem;font-weight:700;color:var(--gold-l);">Selecionar MÃªs</div>
        <button onclick="fecharSeletorMes()" style="background:none;border:none;color:var(--text2);font-size:1.4rem;cursor:pointer;line-height:1;padding:4px;">Ã—</button>
      </div>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
        <button onclick="navAnoPicker(-1)" style="background:var(--bg4);border:1px solid var(--border2);border-radius:8px;color:var(--text);padding:6px 14px;cursor:pointer;font-size:1rem;">â€¹</button>
        <span id="picker-ano" style="font-family:'Cormorant Garamond',serif;font-size:1.3rem;font-weight:700;color:var(--text);"></span>
        <button onclick="navAnoPicker(1)" style="background:var(--bg4);border:1px solid var(--border2);border-radius:8px;color:var(--text);padding:6px 14px;cursor:pointer;font-size:1rem;">â€º</button>
      </div>
      <div id="picker-meses-grid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;"></div>
    </div>
  </div>

  <!-- Totais do mÃªs -->
  <div class="stats-row" style="margin-bottom:24px;" id="conf-stats"></div>

  <!-- Cards de comissÃµes do mÃªs -->
  <div id="conf-cards-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:16px;margin-bottom:32px;"></div>

  <div id="conf-empty" style="display:none">
    <div class="empty"><div class="ei">ğŸ“­</div><p>Nenhuma comissÃ£o prevista para este mÃªs.</p></div>
  </div>

</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TAB: COMISSÃ•ES FINALIZADAS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-content" id="tab-finalizadas">

  <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:16px;margin-bottom:24px;">
    <div>
      <div class="sec-title" style="margin-bottom:4px">ğŸ† ComissÃµes Finalizadas</div>
      <div style="font-size:0.78rem;color:var(--text2)">Vendas com todas as comissÃµes jÃ¡ recebidas (status: Pago Integralmente)</div>
    </div>
    <div class="stats-row" style="margin-bottom:0;flex:1;min-width:300px;" id="fin-stats"></div>
  </div>

  <div id="fin-cards-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;margin-bottom:32px;"></div>
  <div id="fin-empty" style="display:none">
    <div class="empty"><div class="ei">ğŸ†</div><p>Nenhuma comissÃ£o finalizada ainda.<br>Marque as vendas como <strong>Pago Integralmente</strong> na aba ConferÃªncia.</p></div>
  </div>

</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TAB: BOLETOS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-content" id="tab-boletos-content">

  <div class="alert-section">
    <div class="sec-title" style="color:var(--red)" id="alert-section-title">âš ï¸ Boletos Vencendo Este MÃªs</div>
    <div class="alert-list" id="alert-list"></div>
  </div>

  <div class="table-card">
    <div class="sec-title">Todos os Boletos</div>
    <div class="twrap">
      <table>
        <thead>
          <tr><th>Cliente</th><th>Empreendimento</th><th>Valor Venda</th><th>Entrada</th><th>% Entrada</th><th>Boleto</th><th>ComissÃ£o</th><th>Vencimento</th><th>Recebo em</th><th>Dias Rest.</th><th>Status</th></tr>
        </thead>
        <tbody id="tbody-boletos"></tbody>
      </table>
    </div>
  </div>

</div>

</div><!-- /wrap -->

<!-- â•â• BOOT LOADING â•â•â•â•â•â•â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="boot-msg" style="display:none;position:fixed;inset:0;z-index:9999;background:var(--bg);align-items:center;justify-content:center;flex-direction:column;gap:16px;">
  <div style="font-size:2.5rem;animation:spin 1s linear infinite">âš™ï¸</div>
  <div style="font-family:'Cormorant Garamond',serif;font-size:1.4rem;color:var(--gold-l)">Conectando ao banco...</div>
</div>
<style>@keyframes spin{to{transform:rotate(360deg)}}</style>

<!-- â•â• CONFIG OVERLAY â•â•â•â•â•â•â•â•â•â•â•â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="overlay" id="config-overlay">
  <div class="mbox" style="max-width:480px;text-align:left;">
    <div style="text-align:center;margin-bottom:20px;">
      <div style="font-size:2.5rem;margin-bottom:8px">ğŸ”§</div>
      <h3 style="font-family:'Cormorant Garamond',serif;font-size:1.5rem;color:var(--gold-l)">Configurar Banco de Dados</h3>
      <p style="color:var(--text2);font-size:0.8rem;margin-top:6px;">Cole abaixo as credenciais do seu projeto Supabase</p>
    </div>

    <div style="display:flex;flex-direction:column;gap:14px;">
      <div class="field">
        <label>URL do Projeto Supabase</label>
        <input type="text" id="cfg-url" placeholder="https://xxxxxxxxxxxx.supabase.co" style="font-size:0.8rem;">
      </div>
      <div class="field">
        <label>Chave Anon/Public (API Key)</label>
        <input type="text" id="cfg-key" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6..." style="font-size:0.8rem;">
      </div>
    </div>

    <div style="background:rgba(201,168,76,0.06);border:1px solid rgba(201,168,76,0.2);border-radius:var(--r3);padding:14px;margin:18px 0;font-size:0.75rem;color:var(--text2);line-height:1.7;">
      <strong style="color:var(--gold-l)">Como obter as credenciais:</strong><br>
      1. Acesse <strong>supabase.com</strong> e crie um projeto gratuito<br>
      2. VÃ¡ em <strong>Project Settings â†’ API</strong><br>
      3. Copie a <strong>Project URL</strong> e a chave <strong>anon public</strong><br>
      4. Cole aqui e clique em Conectar
    </div>

    <div style="background:rgba(91,143,212,0.07);border:1px solid rgba(91,143,212,0.2);border-radius:var(--r3);padding:12px;font-size:0.73rem;color:var(--text2);line-height:1.65;margin-bottom:18px;">
      <strong style="color:var(--blue)">ğŸ—ƒï¸ SQL para criar a tabela</strong> â€” rode no <strong>SQL Editor</strong> do Supabase:<br>
      <code style="display:block;margin-top:8px;background:var(--bg);padding:10px;border-radius:6px;font-size:0.7rem;white-space:pre-wrap;color:var(--green);line-height:1.5;">CREATE TABLE vendas (
  id text PRIMARY KEY,
  data_venda date,
  cliente text,
  localizador text,
  liner text,
  empreendimento text,
  valor numeric,
  entrada numeric DEFAULT 0,
  forma_entrada text,
  venc_entrada date,
  forma_pagamento text,
  parcelas_credito int DEFAULT 1,
  boletos text DEFAULT '[]',
  status text DEFAULT 'ativo',
  nota text DEFAULT '',
  created_at timestamptz DEFAULT now()
);
-- Liberar acesso pÃºblico (RLS off para uso pessoal)
ALTER TABLE vendas DISABLE ROW LEVEL SECURITY;</code>
    </div>

    <button class="btn-reg" style="width:100%;justify-content:center;margin-top:0;" onclick="saveConfig()">ğŸ”Œ Conectar ao Supabase</button>
    <div style="text-align:center;margin-top:10px;">
      <button onclick="hideConfig();renderAll();" style="background:none;border:none;color:var(--text3);font-size:0.75rem;cursor:pointer;font-family:'Inter',sans-serif;">Usar sem banco (dados locais temporÃ¡rios)</button>
    </div>
  </div>
</div>

<!-- Modal Remover -->
<div class="overlay" id="modal">
  <div class="mbox">
    <h3>Remover Venda?</h3>
    <p>Esta aÃ§Ã£o nÃ£o pode ser desfeita.<br>A venda e todas as parcelas de comissÃ£o serÃ£o removidas.</p>
    <div class="mbtns">
      <button class="btn-cancel" onclick="closeModal()">Cancelar</button>
      <button class="btn-del" onclick="confirmDel()">Remover</button>
    </div>
  </div>
</div>

<!-- Edit Overlay -->
<div class="edit-overlay" id="edit-overlay" onclick="if(event.target===this)closeEdit()">
  <div class="edit-box">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;">
      <h3 style="font-family:'Cormorant Garamond',serif;font-size:1.4rem;color:var(--gold-l)">âœï¸ Editar Venda</h3>
      <button onclick="closeEdit()" style="background:none;border:1px solid var(--border2);border-radius:8px;width:34px;height:34px;color:var(--text2);cursor:pointer;font-size:1.1rem;display:flex;align-items:center;justify-content:center;">âœ•</button>
    </div>
    <div class="form-grid" id="edit-form-grid">
      <div class="field"><label>Data da Venda</label><input type="date" id="e-data"></div>
      <div class="field"><label>Nome do Cliente</label><input type="text" id="e-cliente" placeholder="JoÃ£o da Silva"></div>
      <div class="field"><label>Localizador</label><input type="text" id="e-loc" placeholder="LOC-00123"></div>
      <div class="field"><label>Liner ResponsÃ¡vel</label><input type="text" id="e-liner" placeholder="Carlos Mendes"></div>
      <div class="field">
        <label>Empreendimento</label>
        <select id="e-emp">
          <option value="">Selecione...</option>
          <option>Golden Dolphin Grande Hotel</option>
          <option>Hot Springs</option>
          <option>Supreme</option>
        </select>
      </div>
      <div class="field"><label>Valor da Venda (R$)</label><input type="number" id="e-valor" min="0" step="0.01" oninput="onEditValorChange()"></div>
      <div class="field"><label>Valor da Entrada (R$)</label><input type="number" id="e-entrada" min="0" step="0.01" oninput="onEditValorChange()"></div>
      <div class="field">
        <label>Forma da Entrada</label>
        <select id="e-forma-entrada">
          <option value="">Selecione...</option>
          <option value="pix">Pix</option>
          <option value="debito">DÃ©bito</option>
          <option value="credito">CrÃ©dito</option>
          <option value="boleto">Boleto</option>
        </select>
      </div>
      <div class="field">
        <label>Forma de Pagamento (Saldo)</label>
        <select id="e-pag" onchange="onEditPagChange()">
          <option value="">Selecione...</option>
          <option value="pix">Pix / DÃ©bito</option>
          <option value="credito">CrÃ©dito</option>
          <option value="boleto">Boleto (Livre)</option>
        </select>
      </div>
      <div class="field hidden" id="ef-parc">
        <label>NÂº de Parcelas (CrÃ©dito)</label>
        <select id="e-parc">
          <option value="1">1x</option><option value="2">2x</option><option value="3">3x</option>
          <option value="4">4x</option><option value="5">5x</option><option value="6">6x</option>
          <option value="7">7x</option><option value="8">8x</option><option value="9">9x</option>
          <option value="10">10x</option>
        </select>
      </div>
      <div class="field hidden" id="ef-nboletos">
        <label>NÂº de Boletos</label>
        <select id="e-nboletos" onchange="gerarCamposBoletoEdit()">
          <option value="1">1</option><option value="2">2</option><option value="3">3</option>
          <option value="4">4</option><option value="5">5</option><option value="6">6</option>
          <option value="7">7</option>
        </select>
      </div>
    </div>
    <div id="ef-boletos-datas" style="display:none;margin-bottom:16px;">
      <div style="font-size:0.7rem;color:var(--text2);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:10px;">ğŸ“… Vencimentos e Valores dos Boletos</div>
      <div id="e-boletos-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px;"></div>
    </div>
    <div style="display:flex;gap:10px;margin-top:4px;">
      <button class="btn-reg" onclick="saveEdit()" style="flex:1;justify-content:center;margin-top:0;">ğŸ’¾ Salvar AlteraÃ§Ãµes</button>
      <button onclick="closeEdit()" style="background:var(--bg4);border:1px solid var(--border2);border-radius:var(--r2);padding:13px 20px;color:var(--text2);font-family:'Inter',sans-serif;font-size:0.875rem;cursor:pointer;">Cancelar</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â•â• SUPABASE CONFIG â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Estas variÃ¡veis sÃ£o preenchidas pelo usuÃ¡rio na tela de configuraÃ§Ã£o
let SUPA_URL = localStorage.getItem('supa_url') || '';
let SUPA_KEY  = localStorage.getItem('supa_key') || '';

function supaHeaders(){
  return {
    'Content-Type':'application/json',
    'apikey': SUPA_KEY,
    'Authorization': 'Bearer '+SUPA_KEY,
    'Prefer':'return=representation'
  };
}

async function dbFetch(path, opts={}){
  const r = await fetch(SUPA_URL+'/rest/v1/'+path, {
    headers: supaHeaders(), ...opts
  });
  if(!r.ok){ const e=await r.text(); throw new Error(e); }
  const t = await r.text();
  return t ? JSON.parse(t) : [];
}

// â•â• Estado â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let vendas = [];
let filterCur = 'todos';
let delId = null;
let charts = {};
let dbOk = false;  // true quando conectado ao Supabase

// â•â• Persist â€” Supabase â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadVendas(){
  if(!SUPA_URL||!SUPA_KEY){ vendas=[]; return; }
  try {
    const rows = await dbFetch('vendas?order=created_at.desc');
    vendas = rows.map(rowToVenda);
    dbOk = true;
    hideConfig();
  } catch(e){
    console.error('Supabase load error:',e);
    toast('Erro ao conectar ao banco. Verifique as credenciais.',true);
  }
}

async function saveVenda(v){
  const result = await dbFetch('vendas', {
    method:'POST',
    body: JSON.stringify(vendaToRow(v))
  });
  return Array.isArray(result) ? result : [result];
}

async function deleteVenda(id){
  await dbFetch('vendas?id=eq.'+id, { method:'DELETE' });
}

async function patchVenda(id, fields){
  await dbFetch('vendas?id=eq.'+id, {
    method:'PATCH',
    body: JSON.stringify(fields)
  });
}

// ConversÃ£o venda JS â†” row Supabase
function vendaToRow(v){
  return {
    id: String(v.id),
    data_venda: v.data,
    cliente: v.cliente,
    localizador: v.loc||'',
    liner: v.liner,
    empreendimento: v.emp,
    valor: v.valor,
    entrada: v.entrada||0,
    forma_entrada: v.formaEntrada||'',
    venc_entrada: v.vencEntrada||null,
    forma_pagamento: v.pag,
    parcelas_credito: v.parc||1,
    boletos: JSON.stringify(v.boletos||[]),
    status: v.status||'ativo',
    nota: v.nota||''
  };
}

function rowToVenda(r){
  let boletos = [];
  try{
    boletos = typeof r.boletos==='string' ? JSON.parse(r.boletos||'[]') : (r.boletos||[]);
  }catch(e){ boletos=[]; }
  return {
    id: r.id,
    data: r.data_venda,
    cliente: r.cliente,
    loc: r.localizador,
    liner: r.liner,
    emp: r.empreendimento,
    valor: parseFloat(r.valor)||0,
    entrada: parseFloat(r.entrada)||0,
    formaEntrada: r.forma_entrada||'',
    vencEntrada: r.venc_entrada||'',
    pag: r.forma_pagamento,
    parc: r.parcelas_credito||1,
    boletos,
    status: r.status||'ativo',
    nota: r.nota||''
  };
}

// Compatibilidade â€” save sÃ­ncrono vira no-op (usamos funÃ§Ãµes async dedicadas)
const save = () => {};

// â•â• Init form â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('f-data').valueAsDate = new Date();

// â•â• Utils â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const fmt = v => v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const fmtK = v => v >= 1000 ? 'R$'+(v/1000).toFixed(0)+'k' : fmt(v);

function addMonths(dateStr, n){
  const d = new Date(dateStr+'T12:00:00');
  d.setMonth(d.getMonth()+n);
  return d;
}

const getProxMes = () => { const n=new Date(); return new Date(n.getFullYear(),n.getMonth()+1,1); };
const isProxMes = d => { const p=getProxMes(); return d.getMonth()===p.getMonth()&&d.getFullYear()===p.getFullYear(); };
const isPast = d => { const n=new Date(); return d < new Date(n.getFullYear(),n.getMonth(),1); };

function diasAteVenc(dateStr){
  if(!dateStr) return null;
  const hoje = new Date(); hoje.setHours(0,0,0,0);
  const venc = new Date(dateStr+'T12:00:00'); venc.setHours(0,0,0,0);
  return Math.round((venc-hoje)/(1000*60*60*24));
}

// Gera descriÃ§Ã£o legÃ­vel dos boletos agrupados por valor
// Ex: "4Ã— R$ 5.000,00 + 3Ã— R$ 3.000,00"
function descricaoBoletos(v){
  if(!v || v.pag !== 'boleto') return '';
  const boletos = (v.boletos||[]).filter(b=>b && getBoletoData(b));
  if(!boletos.length) return '';

  // Agrupa por valor (arredonda para 2 casas para evitar flutuaÃ§Ã£o)
  const grupos = {};
  boletos.forEach(b=>{
    const val = getBoletoValor(b, 0);
    const key = val.toFixed(2);
    grupos[key] = (grupos[key]||0) + 1;
  });

  // Ordena por quantidade desc, depois por valor desc
  const partes = Object.entries(grupos)
    .sort((a,b)=> b[1]-a[1] || parseFloat(b[0])-parseFloat(a[0]))
    .map(([val,qtd])=> `${qtd}Ã— ${fmt(parseFloat(val))}`);

  return partes.join(' + ');
}

// â•â• Parcelas comissÃ£o â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 6% bruto = Captador 1% + VocÃª 1,5% + Empresa 3,5%
//
// BOLETO â€” EXEMPLO (venda fev, entrada R$500 Pix, 1% captador = R$400):
//   Captador recebe R$400 em MARÃ‡O (M+1 da venda)
//   Sobra entrada (500 - 400 = 100): sua fatia vem tambÃ©m em MARÃ‡O
//   Bol1 vence marÃ§o â†’ vocÃª recebe em ABRIL (+30d)
//   Bol2 vence abril â†’ vocÃª recebe em MAIO (+30d)
//   ... e assim por diante
//   P3 e P4 sÃ£o os maiores | P5 Ã© o menor (fecha os 6%)
//
// PIX puro: comissÃ£o em M+1
// CRÃ‰DITO: atÃ© 5x a partir de M+2
function getBoletoData(b){ return typeof b==='object' ? b.data : b; }
function getBoletoValor(b, fallback){ return (typeof b==='object' && b.valor) ? b.valor : fallback; }
function recDate30d(dateStr){ return new Date(new Date(dateStr+'T12:00:00').getTime() + 30*24*60*60*1000); }

function calcMinhosRecebimentos(v){
  if(v.pag==='pix'){
    return [{ val: v.valor*0.015, data: addMonths(v.data,1), label:'ComissÃ£o Ã  Vista' }];
  }
  if(v.pag==='credito'){
    const com = v.valor*0.015;
    const n = Math.min(v.parc||1, 5);
    return Array.from({length:n},(_,i)=>({ val:com/n, data:addMonths(v.data,2+i), label:`CrÃ©dito ${i+1}/${n}` }));
  }
  if(v.pag==='boleto'){
    const boletos = (v.boletos||[]).filter(b=>b && getBoletoData(b));
    const nBol = boletos.length;
    if(nBol === 0) return [];

    const totalVenda  = v.valor;
    const comCaptador = totalVenda * 0.01;
    const suaComissao = totalVenda * 0.015;
    const pcts = [];

    // Caso simples: sÃ³ 1 boleto (venda 2x) â†’ tudo Ã  vista, 30d apÃ³s bol1
    if(nBol === 1){
      pcts.push({ val:suaComissao, data:recDate30d(getBoletoData(boletos[0])), label:'ComissÃ£o Ã  Vista', boletoVenc:getBoletoData(boletos[0]) });
      return pcts;
    }

    // â”€â”€ P1: sobra da entrada apÃ³s pagar captador â”€â”€
    // Captador leva 1% em M+1. O restante da entrada (sobra) Ã© dividido:
    // vocÃª fica com sua proporÃ§Ã£o (1,5 de 5% = 30% da sobra lÃ­quida de comissÃµes)
    const entradaVal   = v.entrada > 0 ? v.entrada : 0;
    const sobraEntrada = Math.max(0, entradaVal - comCaptador);
    const suaP1        = sobraEntrada * (1.5/5); // 30% da sobra

    // P1 sempre cai em M+1 da venda (junto com o captador)
    if(suaP1 > 0.01){
      pcts.push({ val:suaP1, data:addMonths(v.data, 1), label:'P1 â€” Sobra entrada (M+1)' });
    }

    // â”€â”€ P2 a P5: seguem boletos SEQUENCIALMENTE (bol1â†’P2, bol2â†’P3, bol3â†’P4, bol4â†’P5) â”€â”€
    // P5 = 9% da sua comissÃ£o total (apenas para fechar os 6%)
    // Restante (91%) dividido entre P2, P3, P4: P3=P4 maiores e iguais, P2 menor
    const saldo  = suaComissao - suaP1;
    const par5   = suaComissao * 0.09;           // 9% fixo â€” o menor
    const resto  = saldo - par5;                  // o que sobra para P2/P3/P4
    const par3   = resto * 0.36;                  // maior (igual a P4)
    const par4   = resto * 0.36;                  // maior (igual a P3)
    const par2   = resto - par3 - par4;           // bom (~28% do resto)

    // Pega boleto por Ã­ndice sequencial (0=1Âº boleto, 1=2Âº, etc.)
    // Se nBol < 4, os Ãºltimos pagamentos caem todos no Ãºltimo boleto disponÃ­vel
    const bSeq = (i) => boletos[Math.min(i, nBol-1)];

    pcts.push({ val:par2, data:recDate30d(getBoletoData(bSeq(0))), label:'P2',          boletoVenc:getBoletoData(bSeq(0)) });
    pcts.push({ val:par3, data:recDate30d(getBoletoData(bSeq(1))), label:'P3 â€” Pico',   boletoVenc:getBoletoData(bSeq(1)) });
    pcts.push({ val:par4, data:recDate30d(getBoletoData(bSeq(2))), label:'P4 â€” Pico',   boletoVenc:getBoletoData(bSeq(2)) });
    pcts.push({ val:par5, data:recDate30d(getBoletoData(bSeq(3))), label:'P5 â€” Ajuste', boletoVenc:getBoletoData(bSeq(3)) });

    return pcts;
  }
  return [];
}

function parcelas(v){ return calcMinhosRecebimentos(v); }

function proxMesVenda(v){ return parcelas(v).filter(p=>isProxMes(p.data)).reduce((s,p)=>s+p.val,0); }

// â•â• Stats globais â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcStats(){
  let total=0,prox=0,fut=0,rec=0,vol=0;
  const porMes={};
  vendas.forEach(v=>{
    vol += v.valor;
    parcelas(v).forEach(p=>{
      total += p.val;
      const k=`${p.data.getFullYear()}-${String(p.data.getMonth()+1).padStart(2,'0')}`;
      porMes[k]=(porMes[k]||0)+p.val;
      if(isProxMes(p.data)) prox+=p.val;
      else if(isPast(p.data)) rec+=p.val;
      else fut+=p.val;
    });
  });
  // Boletos: todas as vendas com pag=boleto que tenham pelo menos um boleto cadastrado
  const boletosVendas = vendas.filter(v=>v.pag==='boleto'&&v.boletos&&v.boletos.filter(b=>b&&getBoletoData(b)).length>0);
  return {total,prox,fut,rec,vol,porMes,boletosVendas};
}

// â•â• Render Month Sales â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMonthSales(){
  const now = new Date();
  const curKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  const curLabel = now.toLocaleString('pt-BR',{month:'long',year:'numeric'});

  const vendasMes = vendas.filter(v=>{
    const d = new Date(v.data+'T12:00:00');
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}` === curKey;
  });
  const totalMes = vendasMes.reduce((s,v)=>s+v.valor, 0);
  const nMes = vendasMes.length;
  const comMes = vendasMes.reduce((s,v)=>s+v.valor*0.015, 0);

  const grid = document.getElementById('month-sales-grid');
  if(!grid) return;

  grid.innerHTML = `
    <div class="month-cell cur-month">
      <div class="mc-name">${curLabel}</div>
      <div class="mc-val">${totalMes>0 ? fmt(totalMes) : 'R$ 0,00'}</div>
      <div class="mc-n">${nMes} venda${nMes!==1?'s':''}</div>
    </div>
  `;
}

// â•â• Render Stats Cards â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderStats(){
  const {total,prox,fut,rec,vol,boletosVendas}=calcStats();
  document.getElementById('s-total').textContent = fmt(total);
  document.getElementById('s-vendas').textContent = `${vendas.length} venda${vendas.length!==1?'s':''}`;
  document.getElementById('s-prox').textContent = fmt(prox);
  const pm = getProxMes().toLocaleString('pt-BR',{month:'long'});
  document.getElementById('s-prox-l').textContent = `Em ${pm.charAt(0).toUpperCase()+pm.slice(1)}`;
  document.getElementById('s-fut').textContent = fmt(fut);
  document.getElementById('s-rec').textContent = fmt(rec);
  document.getElementById('s-vol').textContent = fmt(vol);

  // Contar boletos ativos (sem concluÃ­dos e sem vencidos hÃ¡ +30 dias)
  const hoje = new Date(); hoje.setHours(0,0,0,0);
  const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
  const fimMes    = new Date(hoje.getFullYear(), hoje.getMonth()+1, 0); fimMes.setHours(23,59,59,999);
  const todosBoletos = [];
  vendas.filter(v=>v.pag==='boleto'&&v.status!=='concluido').forEach(v=>{
    (v.boletos||[]).forEach((b,i)=>{ 
      const bv=getBoletoData(b); 
      if(!bv) return;
      const d = diasAteVenc(bv);
      if(d !== null && d < -30) return; // ignora muito vencidos
      todosBoletos.push({v, bv, i, d}); 
    });
  });
  const bVencMes = todosBoletos.filter(b=>{ 
    const dt = new Date(b.bv+'T12:00:00'); 
    return dt >= inicioMes && dt <= fimMes; 
  });
  const bUrgente = todosBoletos.filter(b=>b.d!==null&&b.d>=0&&b.d<=7);
  document.getElementById('s-bol').textContent = todosBoletos.length;
  document.getElementById('s-bol-l').textContent = `${bVencMes.length} vencem este mÃªs`;
  document.getElementById('hb-prox').textContent = fmt(prox);
  document.getElementById('hb-total').textContent = fmt(total);
  if(bUrgente.length>0){
    document.getElementById('hb-alert').style.display='block';
    document.getElementById('hb-alert-count').textContent = bUrgente.length+' boleto'+(bUrgente.length>1?'s':'')+' vencendo esta semana';
  } else {
    document.getElementById('hb-alert').style.display='none';
  }
}

// â•â• Charts â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const COLORS = {
  pix: '#3ECFB8',
  credito: '#5B8FD4',
  boleto: '#E09040',
  'Golden Dolphin Grande Hotel': '#C9A84C',
  'Hot Springs': '#9B7FC6',
  'Supreme': '#E06858',
};

function destroyChart(id){ if(charts[id]){ charts[id].destroy(); delete charts[id]; } }

function renderCharts(){
  const pixCount = vendas.filter(v=>v.pag==='pix').length;
  const credCount = vendas.filter(v=>v.pag==='credito').length;
  const bolCount = vendas.filter(v=>v.pag==='boleto').length;
  const total = vendas.length||1;

  const empData = {};
  ['Golden Dolphin Grande Hotel','Hot Springs','Supreme'].forEach(e=>{ empData[e]=0; });
  vendas.forEach(v=>{ if(empData[v.emp]!==undefined) empData[v.emp]+=v.valor; });

  // â”€â”€ Donut Pagamento â”€â”€
  destroyChart('donut');
  const ctxD = document.getElementById('chart-donut').getContext('2d');
  charts['donut'] = new Chart(ctxD,{
    type:'doughnut',
    data:{
      labels:['Pix/DÃ©bito','CrÃ©dito','Boleto'],
      datasets:[{
        data:[pixCount,credCount,bolCount],
        backgroundColor:['rgba(62,207,184,0.85)','rgba(91,143,212,0.85)','rgba(224,144,64,0.85)'],
        borderColor:['#3ECFB8','#5B8FD4','#E09040'],
        borderWidth:1.5, hoverOffset:6,
      }]
    },
    options:{
      cutout:'72%', responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{display:false}, tooltip:{
        callbacks:{label: ctx=>`${ctx.label}: ${ctx.raw} (${Math.round(ctx.raw/total*100)}%)`}
      }}
    }
  });
  document.getElementById('dc-total').textContent = vendas.length;

  // Legend pag
  document.getElementById('legend-pag').innerHTML = [
    {lbl:'Pix/DÃ©bito',c:'#3ECFB8',n:pixCount},
    {lbl:'CrÃ©dito',c:'#5B8FD4',n:credCount},
    {lbl:'Boleto',c:'#E09040',n:bolCount}
  ].map(x=>`<div class="lpill"><div class="lpill-dot" style="background:${x.c}"></div><span>${x.lbl}: ${x.n}</span></div>`).join('');

  // â”€â”€ Donut Empreendimento â”€â”€
  destroyChart('emp');
  const empVals = Object.values(empData);
  const empKeys = Object.keys(empData);
  const ctxE = document.getElementById('chart-emp').getContext('2d');
  charts['emp'] = new Chart(ctxE,{
    type:'doughnut',
    data:{
      labels: empKeys,
      datasets:[{
        data: empVals,
        backgroundColor:['rgba(201,168,76,0.85)','rgba(155,127,198,0.85)','rgba(224,104,88,0.85)'],
        borderColor:['#C9A84C','#9B7FC6','#E06858'],
        borderWidth:1.5, hoverOffset:6,
      }]
    },
    options:{
      cutout:'72%', responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{display:false}, tooltip:{
        callbacks:{label: ctx=>`${ctx.label}: ${fmt(ctx.raw)}`}
      }}
    }
  });
  const volTotal = empVals.reduce((a,b)=>a+b,0);
  document.getElementById('dc-vol').textContent = volTotal>=1000000 ? 'R$'+(volTotal/1000000).toFixed(1)+'M' : fmtK(volTotal);

  // Legend emp
  document.getElementById('legend-emp').innerHTML = [
    {lbl:'Golden Dolphin',c:'#C9A84C'},
    {lbl:'Hot Springs',c:'#9B7FC6'},
    {lbl:'Supreme',c:'#E06858'}
  ].map(x=>`<div class="lpill"><div class="lpill-dot" style="background:${x.c}"></div><span>${x.lbl}</span></div>`).join('');

  // â”€â”€ Bar: Recebimentos por mÃªs â”€â”€
  const {porMes} = calcStats();
  const allKeys = Object.keys(porMes).sort();
  // Garantir prÃ³x mÃªs aparece
  const proxKey = `${getProxMes().getFullYear()}-${String(getProxMes().getMonth()+1).padStart(2,'0')}`;
  if(!allKeys.includes(proxKey)) allKeys.push(proxKey);
  allKeys.sort();

  const barLabels = allKeys.map(k=>{ const [a,m]=k.split('-'); return new Date(+a,+m-1,1).toLocaleString('pt-BR',{month:'short',year:'2-digit'}); });
  const barData = allKeys.map(k=>parseFloat((porMes[k]||0).toFixed(2)));
  const barColors = allKeys.map(k=>{ const [a,m]=k.split('-'); const d=new Date(+a,+m-1,1); return isProxMes(d)?'rgba(201,168,76,0.9)':isPast(d)?'rgba(62,207,184,0.6)':'rgba(91,143,212,0.7)'; });

  destroyChart('bar');
  const ctxB = document.getElementById('chart-bar').getContext('2d');
  charts['bar'] = new Chart(ctxB,{
    type:'bar',
    data:{
      labels: barLabels,
      datasets:[{ data:barData, backgroundColor:barColors, borderRadius:6, borderSkipped:false }]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label: c=>`${fmt(c.raw)}` } } },
      scales:{
        x:{ grid:{color:'rgba(255,255,255,0.04)'}, ticks:{color:'#8E8A7E',font:{size:10}} },
        y:{ grid:{color:'rgba(255,255,255,0.04)'}, ticks:{color:'#8E8A7E',font:{size:10}, callback:v=>fmtK(v)} }
      }
    }
  });

  // â”€â”€ % PanorÃ¢mica pagamento â”€â”€
  const pctPagData = [
    {lbl:'Pix / DÃ©bito', n:pixCount, color:'#3ECFB8'},
    {lbl:'CrÃ©dito', n:credCount, color:'#5B8FD4'},
    {lbl:'Boleto', n:bolCount, color:'#E09040'},
  ];
  document.getElementById('pct-pag').innerHTML = pctPagData.map(x=>{
    const pct = total>0 ? Math.round(x.n/total*100) : 0;
    return `<div class="pbar-row">
      <div class="pbar-top"><span class="pbar-lbl">${x.lbl}</span><span class="pbar-pct" style="color:${x.color}">${pct}% <span style="color:var(--text3);font-weight:400">(${x.n})</span></span></div>
      <div class="pbar-track"><div class="pbar-fill" style="width:${pct}%;background:${x.color}"></div></div>
    </div>`;
  }).join('');

  // â”€â”€ % PanorÃ¢mica empreendimento â”€â”€
  const empVolTotal = volTotal||1;
  const pctEmpData = [
    {lbl:'Golden Dolphin', v:empData['Golden Dolphin Grande Hotel'], color:'#C9A84C'},
    {lbl:'Hot Springs', v:empData['Hot Springs'], color:'#9B7FC6'},
    {lbl:'Supreme', v:empData['Supreme'], color:'#E06858'},
  ];
  document.getElementById('pct-emp').innerHTML = pctEmpData.map(x=>{
    const pct = empVolTotal>0 ? Math.round(x.v/empVolTotal*100) : 0;
    return `<div class="pbar-row">
      <div class="pbar-top"><span class="pbar-lbl">${x.lbl}</span><span class="pbar-pct" style="color:${x.color}">${pct}% <span style="color:var(--text3);font-weight:400">${fmt(x.v)}</span></span></div>
      <div class="pbar-track"><div class="pbar-fill" style="width:${pct}%;background:${x.color}"></div></div>
    </div>`;
  }).join('');
}

// â•â• Timeline ProjeÃ§Ã£o â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTimeline(){
  const {porMes}=calcStats();
  const allKeys = Object.keys(porMes).sort();
  const proxKey = `${getProxMes().getFullYear()}-${String(getProxMes().getMonth()+1).padStart(2,'0')}`;
  if(!allKeys.includes(proxKey)) allKeys.push(proxKey);
  allKeys.sort();

  if(allKeys.length===0){
    document.getElementById('proj-timeline').innerHTML=`<div style="color:var(--text2);font-size:0.85rem;padding:20px">Nenhuma venda cadastrada ainda.</div>`;
    return;
  }

  document.getElementById('proj-timeline').innerHTML = allKeys.map(k=>{
    const [a,m]=k.split('-');
    const d=new Date(+a,+m-1,1);
    const isP=isProxMes(d), wasPast=isPast(d);
    const label=d.toLocaleString('pt-BR',{month:'long',year:'numeric'});
    const val=porMes[k]||0;
    let tag='', cls='';
    if(isP){ cls='pnext'; tag='<span class="pm-tag next">â­ PrÃ³ximo</span>'; }
    else if(wasPast){ cls='ppast'; tag='<span class="pm-tag past">âœ… Recebido</span>'; }
    else { tag='<span class="pm-tag future">â³ Previsto</span>'; }
    return `<div class="pmonth ${cls}">
      <div class="pm-label">${label}</div>
      <div class="pm-value">${fmt(val)}</div>
      ${tag}
    </div>`;
  }).join('');
}

function renderAlerts(){
  const hoje = new Date(); hoje.setHours(0,0,0,0);
  const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
  const fimMes    = new Date(hoje.getFullYear(), hoje.getMonth()+1, 0);
  fimMes.setHours(23,59,59,999);

  // Flatten todos boletos â€” excluindo vendas concluÃ­das e boletos vencidos hÃ¡ mais de 30 dias
  const todosBoletos = [];
  vendas.filter(v => v.pag==='boleto' && v.status !== 'concluido').forEach(v=>{
    (v.boletos||[]).forEach((b,i)=>{
      if(!b) return;
      const bv = getBoletoData(b);
      const bVal = getBoletoValor(b, 0);
      if(!bv) return;
      const dias = diasAteVenc(bv);
      // Ocultar boletos vencidos hÃ¡ mais de 30 dias
      if(dias !== null && dias < -30) return;
      todosBoletos.push({ v, b, bv, bVal, i, dias });
    });
  });
  todosBoletos.sort((a,b)=>a.dias-b.dias);

  // Alertas: apenas boletos que vencem NESTE MÃŠS (do dia 1 ao Ãºltimo dia do mÃªs)
  const aVencerMes = todosBoletos.filter(({bv})=>{
    const d = new Date(bv+'T12:00:00');
    return d >= inicioMes && d <= fimMes;
  });

  // Badge da aba: urgentes = vencem em atÃ© 7 dias
  const urgentes = todosBoletos.filter(b=>b.dias!==null&&b.dias>=0&&b.dias<=7);
  const tabBol = document.getElementById('tab-boletos');
  tabBol.textContent = urgentes.length>0 ? `ğŸ”” Boletos (${urgentes.length})` : 'ğŸ”” Boletos';

  const mesLabel = hoje.toLocaleString('pt-BR',{month:'long',year:'numeric'});
  const alertList = document.getElementById('alert-list');
  if(aVencerMes.length===0){
    alertList.innerHTML=`<div class="no-alerts"><div class="na-icon">âœ…</div><p>Nenhum boleto vencendo em ${mesLabel}!</p></div>`;
  } else {
    alertList.innerHTML = aVencerMes.map(({v,bv,bVal,i,dias})=>{
      const nBol=(v.boletos||[]).filter(b=>b&&getBoletoData(b)).length;
      const isRed=dias<=3, isOr=dias<=7&&dias>3;
      const cls=dias<0?'red':isRed?'red':isOr?'orange':'yellow';
      const txt=dias<0?`Vencido hÃ¡ ${Math.abs(dias)}d`:dias===0?'Vence HOJE!':dias===1?'Vence AMANHÃƒ':`Vence em ${dias} dias`;
      const dataFmt=new Date(bv+'T12:00:00').toLocaleDateString('pt-BR');
      const recFmt = new Date(new Date(bv+'T12:00:00').getTime()+30*24*60*60*1000).toLocaleDateString('pt-BR');
      const comEssesBoleto = parcelas(v).find(p=>p.boletoVenc===bv);
      const com = comEssesBoleto ? comEssesBoleto.val : 0;
      return `<div class="alert-item">
        <div class="alert-dot ${cls}"></div>
        <div class="alert-info">
          <div class="alert-name">${v.cliente} â€” Boleto ${i+1}/${nBol}${bVal>0?` <span style="color:var(--gold-l);font-size:0.75rem">${fmt(bVal)}</span>`:''}</div>
          <div class="alert-detail">${v.emp} â€¢ Venc: ${dataFmt} â€¢ VocÃª recebe: ${com>0?fmt(com):'â€”'} em ${recFmt}</div>
        </div>
        <div class="alert-days ${cls}">${txt}</div>
      </div>`;
    }).join('');
  }

  // Tabela: todos boletos ativos (sem vencidos hÃ¡ +30 dias, sem concluÃ­dos)
  const tbody = document.getElementById('tbody-boletos');
  if(todosBoletos.length===0){
    tbody.innerHTML=`<tr><td colspan="11"><div class="empty"><div class="ei">ğŸ“„</div><p>Nenhum boleto pendente.</p></div></td></tr>`;
    return;
  }
  tbody.innerHTML = todosBoletos.map(({v,bv,bVal,i,dias})=>{
    const nBol = (v.boletos||[]).filter(b=>b&&getBoletoData(b)).length||1;
    const comEsse = parcelas(v).find(p=>p.boletoVenc===bv);
    const comBoleto = comEsse ? comEsse.val : 0;
    const recDate = new Date(new Date(bv+'T12:00:00').getTime()+30*24*60*60*1000);
    const recFmt = recDate.toLocaleDateString('pt-BR');
    const dataFmt=new Date(bv+'T12:00:00').toLocaleDateString('pt-BR');
    let status='', diasTxt='';
    if(dias<0){ status=`<span class="badge b-venc">Vencido</span>`; diasTxt=`<span style="color:var(--red)">HÃ¡ ${Math.abs(dias)}d</span>`; }
    else if(dias===0){ status=`<span class="badge b-venc">Hoje!</span>`; diasTxt='<span style="color:var(--red)">Hoje</span>'; }
    else if(dias<=3){ status=`<span class="badge" style="background:rgba(224,104,88,0.15);color:var(--red);border:1px solid rgba(224,104,88,0.3)">Urgente</span>`; diasTxt=`<span style="color:var(--red)">${dias}d</span>`; }
    else if(dias<=7){ status=`<span class="badge" style="background:rgba(224,144,64,0.15);color:var(--orange);border:1px solid rgba(224,144,64,0.3)">Em breve</span>`; diasTxt=`<span style="color:var(--orange)">${dias}d</span>`; }
    else { status=`<span class="badge b-pix">Normal</span>`; diasTxt=`${dias}d`; }
    const pctEntrada = v.valor>0?(v.entrada||0)/v.valor:0;
    const pctStr = (pctEntrada*100).toFixed(1)+'%';
    const pctColor = pctEntrada>=0.06 ? 'var(--green)' : 'var(--orange)';
    return `<tr>
      <td><strong>${v.cliente}</strong></td>
      <td>${badgeEmp(v.emp)}</td>
      <td>${fmt(v.valor)}</td>
      <td>${fmt(v.entrada||0)}</td>
      <td><span style="color:${pctColor};font-weight:600">${pctStr}</span></td>
      <td style="color:var(--text2)">${i+1}/${nBol}${bVal>0?` <span style="color:var(--gold-l);font-size:0.75rem">${fmt(bVal)}</span>`:''}</td>
      <td><span class="cv">${comBoleto>0?fmt(comBoleto):'â€”'}</span></td>
      <td>${dataFmt}</td>
      <td style="color:var(--green);font-size:0.8rem">${recFmt}</td>
      <td>${diasTxt}</td>
      <td>${status}</td>
    </tr>`;
  }).join('');
}

// â•â• Tabela Vendas â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function badgeEmp(emp){
  if(emp.includes('Golden')) return `<span class="badge b-gd">Golden Dolphin</span>`;
  if(emp.includes('Hot'))    return `<span class="badge b-hs">Hot Springs</span>`;
  if(emp.includes('Supreme')) return `<span class="badge b-sup">Supreme</span>`;
  return emp;
}

function badgePag(v){
  if(v.pag==='pix') return `<span class="badge b-pix">Pix/DÃ©bito</span>`;
  if(v.pag==='boleto'){
    const nBol=(v.boletos||[]).filter(b=>b&&getBoletoData(b)).length;
    const pct=v.valor>0?(v.entrada||0)/v.valor:0;
    const cor=pct>=0.06?'b-pix':'b-bol';
    return `<span class="badge ${cor}">Boleto ${nBol}x ${pct>=0.06?'(ent. â‰¥6%)':'(ent. <6%)'}</span>`;
  }
  const nc=Math.min(v.parc||1,5);
  return `<span class="badge b-cred">CrÃ©dito ${v.parc}x â†’ ${nc}x</span>`;
}

function renderTable(){
  const tbody=document.getElementById('tbody');
  const q=(document.getElementById('search').value||'').toLowerCase();
  let lista = filterCur==='todos' ? vendas : vendas.filter(v=>v.pag===filterCur);
  if(q) lista=lista.filter(v=>v.cliente.toLowerCase().includes(q)||(v.loc||'').toLowerCase().includes(q));

  if(!lista.length){
    tbody.innerHTML=`<tr><td colspan="12"><div class="empty"><div class="ei">ğŸ“‹</div><p>Nenhuma venda encontrada.</p></div></td></tr>`;
    return;
  }

  tbody.innerHTML=lista.map(v=>{
    const com=v.valor*0.015;
    const prox=proxMesVenda(v);
    const dataFmt=new Date(v.data+'T12:00:00').toLocaleDateString('pt-BR');
    const pctEntrada = v.valor>0?(v.entrada||0)/v.valor:0;
    const pctStr = v.pag==='boleto' ? `<span style="color:${pctEntrada>=0.06?'var(--green)':'var(--orange)'}; font-weight:600">${(pctEntrada*100).toFixed(1)}%</span>` : 'â€”';
    const nBol=(v.boletos||[]).filter(b=>b&&getBoletoData(b)).length;
    const primeiroVenc = v.pag==='boleto'&&nBol>0 ? new Date(getBoletoData((v.boletos||[]).filter(b=>b&&getBoletoData(b))[0])+'T12:00:00').toLocaleDateString('pt-BR')+(nBol>1?` +${nBol-1}`:''): 'â€”';
    const alertaVenc = v.pag==='boleto'&&(v.boletos||[]).some(b=>{ const bv=getBoletoData(b); const d=diasAteVenc(bv); return d!==null&&d<=7; });
    // Status badge
    const st = v.status||'ativo';
    const stBadge = {ativo:`<span class="s-badge s-ativo">âœ… Ativo</span>`,inadimplente:`<span class="s-badge s-inadimplente">âš  Inadimpl.</span>`,cancelado:`<span class="s-badge s-cancelado">âœ– Cancelado</span>`,pago:`<span class="s-badge fin-badge">ğŸ† Pago</span>`}[st]||`<span class="s-badge s-ativo">âœ… Ativo</span>`;
    // Forma entrada
    const feLbl = {pix:'Pix',debito:'DÃ©b.',credito:'Cred.',boleto:'Bol.'}[v.formaEntrada]||'';
    const feColors = {pix:'var(--green)',debito:'var(--blue)',credito:'var(--purple)',boleto:'var(--orange)'};
    const feColor = feColors[v.formaEntrada]||'var(--text2)';
    const entradaStr = `${v.entrada>0?fmt(v.entrada):'â€”'}${feLbl?` <span style="color:${feColor};font-size:0.7rem;font-weight:600">${feLbl}</span>`:''}`;
    return `<tr style="${st==='cancelado'?'opacity:0.5':''}${st==='inadimplente'?';background:rgba(224,104,88,0.03)':''}">
      <td style="white-space:nowrap">${dataFmt}</td>
      <td><strong>${v.cliente}</strong></td>
      <td style="color:var(--text2);font-size:0.78rem">${v.loc||'â€”'}</td>
      <td>${v.liner}</td>
      <td>${badgeEmp(v.emp)}</td>
      <td>${fmt(v.valor)}</td>
      <td>${entradaStr} ${pctStr}</td>
      <td><span class="cv">${fmt(com)}</span></td>
      <td>${badgePag(v)}</td>
      <td style="white-space:nowrap;font-size:0.78rem">${primeiroVenc} ${alertaVenc?'<span class="badge b-venc">âš </span>':''}</td>
      <td>${prox>0?`<span class="cv-green">${fmt(prox)}</span>`:'<span style="color:var(--text3)">â€”</span>'}</td>
      <td>${stBadge}</td>
      <td><div class="action-btns"><button class="edit-btn" onclick="openEdit('${v.id}')">âœï¸</button><button class="del-btn" onclick="openModal('${v.id}')">ğŸ—‘</button></div></td>
    </tr>`;
  }).join('');
}

// â•â• Render all â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll(){
  renderStats();
  renderCharts();
  renderTimeline();
  renderAlerts();
  renderTable();
  renderMonthSales();
  renderFinalizadas();
}

// â•â• Filter â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setFilter(f,btn){
  filterCur=f;
  document.querySelectorAll('.fbtn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderTable();
}

// â•â• Tabs â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(id, btn){
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(b=>b.classList.remove('active'));
  let elId;
  if(id==='boletos') elId='tab-boletos-content';
  else if(id==='Resumo') elId='tab-dashboard';
  else elId='tab-'+id;
  const el = document.getElementById(elId);
  if(el) el.classList.add('active');
  btn.classList.add('active');
  if(id==='Resumo'||id==='dashboard') setTimeout(()=>renderCharts(),50);
  if(id==='conferencia') renderConferencia();
  if(id==='finalizadas') renderFinalizadas();
}

// â•â• Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id){ delId=String(id); document.getElementById('modal').classList.add('show'); }
function closeModal(){ delId=null; document.getElementById('modal').classList.remove('show'); }
async function confirmDel(){
  if(!delId) return;
  try {
    await deleteVenda(delId);
    vendas=vendas.filter(v=>String(v.id)!==delId);
    closeModal(); renderAll(); toast('ğŸ—‘ Venda removida!');
  } catch(e){ toast('Erro ao remover venda.',true); }
}
document.getElementById('modal').addEventListener('click',e=>{ if(e.target===document.getElementById('modal')) closeModal(); });

// â•â• Toast â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg, err=false){
  const t=document.getElementById('toast');
  t.textContent=msg; t.className='toast'+(err?' err':'');
  requestAnimationFrame(()=>{ requestAnimationFrame(()=>{ t.classList.add('show'); }); });
  setTimeout(()=>t.classList.remove('show'),3000);
}

// â•â• Form helpers â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onValorChange(){ renderSim(); atualizarGatilho(); }

function onFormaEntradaChange(){
  const fe = document.getElementById('f-forma-entrada').value;
  document.getElementById('ff-venc-entrada').classList.toggle('hidden', fe !== 'boleto');
  renderSim();
}

function onPagChange(){
  const p=document.getElementById('f-pag').value;
  document.getElementById('ff-parc').classList.toggle('hidden', p!=='credito');
  document.getElementById('ff-nboletos').classList.toggle('hidden', p!=='boleto');
  if(p!=='boleto'){
    document.getElementById('ff-boletos-datas').style.display='none';
  } else {
    gerarCamposBoletos();
  }
  renderSim();
}

function gerarCamposBoletos(){
  const n=parseInt(document.getElementById('f-nboletos').value)||1;
  const grid=document.getElementById('boletos-datas-grid');
  const wrap=document.getElementById('ff-boletos-datas');
  wrap.style.display='block';

  const primeiraAtual = document.getElementById('f-bol-0') ? document.getElementById('f-bol-0').value : '';

  // Salvar valores existentes antes de recriar
  const valsAtuais = Array.from({length:n},(_,i)=>{
    const el = document.getElementById(`f-bol-v-${i}`);
    return el ? el.value : '';
  });

  grid.innerHTML = `
    <!-- Grupos de valor -->
    <div id="grupos-valor-box" style="grid-column:1/-1;background:rgba(201,168,76,0.06);border:1px solid rgba(201,168,76,0.15);border-radius:var(--r2);padding:12px 16px;margin-bottom:4px;">
      <div style="font-size:0.72rem;color:var(--gold-l);font-weight:600;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.08em;">âš¡ Preencher valores por grupo</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;">
        <div>
          <div style="font-size:0.7rem;color:var(--text2);margin-bottom:3px">Grupo A â€” Valor</div>
          <input type="number" id="g-val-a" placeholder="R$ valor" min="0" step="0.01"
            style="width:120px;background:var(--bg4);border:1px solid var(--border2);border-radius:var(--r3);padding:7px 10px;color:var(--text);font-size:0.82rem;outline:none;"
            onfocus="this.style.borderColor='var(--gold)'" onblur="this.style.borderColor='var(--border2)'">
        </div>
        <div>
          <div style="font-size:0.7rem;color:var(--text2);margin-bottom:3px">Qtd boletos A</div>
          <input type="number" id="g-qtd-a" placeholder="qtd" min="1" max="${n}" value=""
            style="width:80px;background:var(--bg4);border:1px solid var(--border2);border-radius:var(--r3);padding:7px 10px;color:var(--text);font-size:0.82rem;outline:none;"
            onfocus="this.style.borderColor='var(--gold)'" onblur="this.style.borderColor='var(--border2)'">
        </div>
        <div>
          <div style="font-size:0.7rem;color:var(--text2);margin-bottom:3px">Grupo B â€” Valor</div>
          <input type="number" id="g-val-b" placeholder="R$ valor" min="0" step="0.01"
            style="width:120px;background:var(--bg4);border:1px solid var(--border2);border-radius:var(--r3);padding:7px 10px;color:var(--text);font-size:0.82rem;outline:none;"
            onfocus="this.style.borderColor='var(--gold)'" onblur="this.style.borderColor='var(--border2)'">
        </div>
        <div>
          <div style="font-size:0.7rem;color:var(--text2);margin-bottom:3px">Qtd boletos B</div>
          <input type="number" id="g-qtd-b" placeholder="qtd" min="0" max="${n}" value=""
            style="width:80px;background:var(--bg4);border:1px solid var(--border2);border-radius:var(--r3);padding:7px 10px;color:var(--text);font-size:0.82rem;outline:none;"
            onfocus="this.style.borderColor='var(--gold)'" onblur="this.style.borderColor='var(--border2)'">
        </div>
        <button onclick="aplicarGrupos()" style="padding:7px 16px;background:var(--gold);color:#1a1208;border:none;border-radius:var(--r3);font-weight:700;font-size:0.8rem;cursor:pointer;align-self:flex-end;">
          âœ“ Aplicar
        </button>
      </div>
    </div>
    ${Array.from({length:n},(_,i)=>`
    <div class="field" style="background:var(--bg3);padding:12px;border-radius:var(--r2);border:1px solid var(--border2);">
      <label>Boleto ${i+1} â€” Vencimento</label>
      <input type="date" id="f-bol-${i}" ${i===0 ? `onchange="autoPreencherBoletos()"` : `onchange="renderSim()"`}>
      <label style="margin-top:8px;display:block;">Valor (R$)</label>
      <input type="number" id="f-bol-v-${i}" placeholder="0,00" min="0" step="0.01"
        style="background:var(--bg4);border:1px solid rgba(255,255,255,0.08);border-radius:var(--r3);padding:9px 12px;color:var(--text);font-family:'Inter',sans-serif;font-size:0.82rem;outline:none;width:100%;margin-top:4px;transition:border-color .2s;"
        onfocus="this.style.borderColor='var(--gold)'" onblur="this.style.borderColor='rgba(255,255,255,0.08)'"
        oninput="renderSim();atualizarTotalBoletos()">
    </div>`).join('')}
  `;

  if(primeiraAtual){
    document.getElementById('f-bol-0').value = primeiraAtual;
    autoPreencherBoletos();
  }

  // Restaurar valores que jÃ¡ existiam
  valsAtuais.forEach((v,i)=>{ const el=document.getElementById(`f-bol-v-${i}`); if(el&&v) el.value=v; });

  renderSim();
}

function aplicarGrupos(){
  const n = parseInt(document.getElementById('f-nboletos').value)||1;
  const valA = parseFloat(document.getElementById('g-val-a').value)||0;
  const qtdA = parseInt(document.getElementById('g-qtd-a').value)||0;
  const valB = parseFloat(document.getElementById('g-val-b').value)||0;
  const qtdB = parseInt(document.getElementById('g-qtd-b').value)||0;

  if(valA <= 0 && valB <= 0) return;

  const total = qtdA + qtdB;
  if(total > n) return;

  for(let i=0;i<n;i++){
    const el = document.getElementById(`f-bol-v-${i}`);
    if(!el) continue;
    if(i < qtdA && valA > 0)           el.value = valA.toFixed(2);
    else if(i < qtdA+qtdB && valB > 0) el.value = valB.toFixed(2);
  }

  renderSim();
}

function atualizarTotalBoletos(){
  // Mantido para compatibilidade, sem exibir nada
}

function autoPreencherBoletos(){
  const primeira = document.getElementById('f-bol-0').value;
  if(!primeira) { renderSim(); return; }

  const base = new Date(primeira + 'T12:00:00');
  const n = parseInt(document.getElementById('f-nboletos').value)||1;

  for(let i=1; i<n; i++){
    const el = document.getElementById(`f-bol-${i}`);
    if(!el) continue;
    // Mesmo dia do mÃªs, i meses Ã  frente
    const prox = new Date(base);
    prox.setMonth(prox.getMonth() + i);
    // Ajuste: se o mÃªs nÃ£o tem esse dia (ex: 31 de fev), volta para o Ãºltimo dia do mÃªs
    if(prox.getDate() !== base.getDate()){
      prox.setDate(0); // Ãºltimo dia do mÃªs anterior
    }
    el.value = prox.toISOString().split('T')[0];
  }
  renderSim();
}

function renderSim(){
  const p=document.getElementById('f-pag').value;
  const val=parseFloat(document.getElementById('f-valor').value)||0;
  const data=document.getElementById('f-data').value;
  const sb=document.getElementById('sim-box');
  if(!p||!data||val<=0){ sb.style.display='none'; return; }
  sb.style.display='block';
  const chips=document.getElementById('sim-chips');
  const fmtM=d=>d.toLocaleString('pt-BR',{month:'short',year:'2-digit'});
  const suaComissao = val * 0.015;
  let html='';

  if(p==='pix'){
    const d=addMonths(data,1);
    html=`<div class="chip ${isProxMes(d)?'next':'future'}" style="border-color:var(--green);color:var(--green)">
        ğŸ’° ComissÃ£o Ã  vista â€” ${fmtM(d)}: <strong>${fmt(suaComissao)}</strong>
      </div>`;

  } else if(p==='credito'){
    const nv=parseInt(document.getElementById('f-parc').value)||1;
    const n=Math.min(nv,5);
    const pc=suaComissao/n;
    html+=`<div style="font-size:0.72rem;color:var(--text2);width:100%;margin-bottom:6px">
        CrÃ©dito ${nv}x â†’ comissÃ£o em <strong style="color:var(--gold-l)">${n}x</strong> a partir de M+2
      </div>`;
    for(let i=0;i<n;i++){
      const d=addMonths(data,2+i);
      html+=`<div class="chip ${isProxMes(d)?'next':'future'}">${i+1}/${n} â€” ${fmtM(d)}: <strong>${fmt(pc)}</strong></div>`;
    }

  } else if(p==='boleto'){
    const n=parseInt(document.getElementById('f-nboletos').value)||1;
    const bolDatas = Array.from({length:n},(_,i)=>{ const el=document.getElementById(`f-bol-${i}`); return el?el.value:''; });
    const entradaVal = parseFloat(document.getElementById('f-entrada').value)||0;
    const comCaptador = val * 0.01;

    // CÃ¡lculos
    const sobraEntrada = Math.max(0, entradaVal - comCaptador);
    const suaP1  = sobraEntrada * (1.5/5);
    const saldo  = suaComissao - suaP1;
    const par5   = suaComissao * 0.09;
    const resto  = saldo - par5;
    const par3   = resto * 0.36;
    const par4   = resto * 0.36;
    const par2   = resto - par3 - par4;

    // Helper â€” sequencial
    const pick = (i) => bolDatas[Math.min(i, n-1)];
    const mkRec = (dateStr) => dateStr ? new Date(new Date(dateStr+'T12:00:00').getTime()+30*24*60*60*1000) : null;

    if(n === 1){
      const rec = mkRec(bolDatas[0]);
      html+= rec
        ? `<div class="chip ${isProxMes(rec)?'next':'future'}" style="border-color:var(--green);color:var(--green)">ğŸ’° ComissÃ£o Ã  vista â€” +30d bol.1 â€” ${fmtM(rec)}: <strong>${fmt(suaComissao)}</strong></div>`
        : `<div class="chip">Defina o vencimento do boleto 1</div>`;
    } else {
      // P1: M+1 da data da venda
      const dataM1 = addMonths(data, 1);
      if(suaP1 > 0.01){
        html+=`<div class="chip ${isProxMes(dataM1)?'next':'future'}" style="border-color:var(--text2)">
          <span style="min-width:140px;display:inline-block">P1 â€” Sobra entrada</span>
          ${fmtM(dataM1)}: <strong>${fmt(suaP1)}</strong>
        </div>`;
      }

      const pagsRem = [
        { label:'P2',            val:par2, idx:0, color:'var(--text2)' },
        { label:'P3 â€” Pico ğŸ”¥',  val:par3, idx:1, color:'var(--gold-l)' },
        { label:'P4 â€” Pico ğŸ”¥',  val:par4, idx:2, color:'var(--gold-l)' },
        { label:'P5 â€” Ajuste â†˜', val:par5, idx:3, color:'var(--orange)' },
      ];
      pagsRem.forEach(({label,val:pv,idx,color})=>{
        const bv = pick(idx);
        const bolNum = Math.min(idx, n-1)+1;
        const rec = mkRec(bv);
        if(rec){
          html+=`<div class="chip ${isProxMes(rec)?'next':'future'}" style="border-color:${color};color:${color}">
            <span style="min-width:140px;display:inline-block">${label}</span>
            +30d bol.${bolNum} â€” ${fmtM(rec)}: <strong>${fmt(pv)}</strong>
          </div>`;
        } else {
          html+=`<div class="chip" style="color:${color}">${label}: defina vencimento do boleto ${bolNum}</div>`;
        }
      });

      html+=`<div style="width:100%;margin-top:8px;font-size:0.72rem;color:var(--text3);text-align:right">
        Total: <strong style="color:var(--gold-l)">${fmt(suaP1+par2+par3+par4+par5)}</strong>
      </div>`;
    }
  }
  chips.innerHTML=html;
}

document.getElementById('f-valor').addEventListener('input', ()=>{ renderSim(); autoFillEntrada(); });
document.getElementById('f-entrada').addEventListener('input', renderSim);
document.getElementById('f-data').addEventListener('change', renderSim);

// â•â• Adicionar venda â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function addVenda(){
  const data=document.getElementById('f-data').value;
  const cliente=document.getElementById('f-cliente').value.trim();
  const loc=document.getElementById('f-loc').value.trim();
  const liner=document.getElementById('f-liner').value.trim();
  const emp=document.getElementById('f-emp').value;
  const valor=parseFloat(document.getElementById('f-valor').value);
  const entrada=parseFloat(document.getElementById('f-entrada').value)||0;
  const formaEntrada=document.getElementById('f-forma-entrada').value;
  const vencEntrada=document.getElementById('f-venc-entrada').value;
  const pag=document.getElementById('f-pag').value;
  const parc=parseInt(document.getElementById('f-parc').value)||1;

  if(!data||!cliente||!liner||!emp||!valor||!pag){ toast('âš ï¸ Preencha todos os campos!',true); return; }

  let boletos=[];
  if(pag==='boleto'){
    const n=parseInt(document.getElementById('f-nboletos').value)||1;
    boletos=Array.from({length:n},(_,i)=>{
      const el=document.getElementById(`f-bol-${i}`);
      const elV=document.getElementById(`f-bol-v-${i}`);
      const dt = el?el.value:'';
      const vl = elV?parseFloat(elV.value)||0:0;
      return dt ? {data:dt, valor:vl} : null;
    }).filter(Boolean);
    if(boletos.some(b=>!b.data)){ toast('âš ï¸ Defina o vencimento de todos os boletos!',true); return; }
  }

  const novaVenda = {
    id: Date.now(), data, cliente, loc, liner, emp, valor, entrada,
    formaEntrada, vencEntrada: formaEntrada==='boleto'?vencEntrada:'',
    pag, parc: pag==='credito'?parc:1, boletos,
    status: 'ativo', nota: ''
  };

  // Salvar no Supabase
  const btnReg = document.querySelector('.btn-reg');
  btnReg.disabled=true; btnReg.textContent='Salvando...';
  try {
    const [row] = await saveVenda(novaVenda);
    // Supabase retorna o row com o id gerado â€” mas usamos nosso id
    vendas.unshift(novaVenda);
    renderAll();
    toast('âœ“ Venda registrada e salva no banco!');
  } catch(e){
    toast('Erro ao salvar no banco: '+e.message, true);
    btnReg.disabled=false; btnReg.innerHTML='ï¼‹ Registrar Venda'; return;
  }
  btnReg.disabled=false; btnReg.innerHTML='ï¼‹ Registrar Venda';

  ['f-cliente','f-loc','f-liner','f-valor','f-entrada'].forEach(i=>document.getElementById(i).value='');
  document.getElementById('f-emp').value='';
  document.getElementById('f-pag').value='';
  document.getElementById('f-forma-entrada').value='';
  document.getElementById('f-venc-entrada').value='';
  document.getElementById('ff-venc-entrada').classList.add('hidden');
  document.getElementById('f-parc').value='1';
  document.getElementById('f-nboletos').value='1';
  document.getElementById('f-data').valueAsDate=new Date();
  document.getElementById('sim-box').style.display='none';
  document.getElementById('ff-parc').classList.add('hidden');
  document.getElementById('ff-nboletos').classList.add('hidden');
  document.getElementById('ff-boletos-datas').style.display='none';
  document.getElementById('gatilho-info').style.display='none';
  document.getElementById('boletos-datas-grid').innerHTML='';

  setTimeout(()=>{
    document.querySelectorAll('.nav-tab').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
    document.getElementById('tab-vendas').classList.add('active');
    document.querySelectorAll('.nav-tab')[2].classList.add('active');
  },800);
}

// â•â• CONFERÃŠNCIA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let confMesOffset = 1; // 1 = prÃ³ximo mÃªs por padrÃ£o

function getConfDate(){
  const n = new Date();
  return new Date(n.getFullYear(), n.getMonth() + confMesOffset, 1);
}

function navMes(dir){
  confMesOffset += dir;
  renderConferencia();
}

// â”€â”€ Month picker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let pickerAno = new Date().getFullYear();
const MESES_PT = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];

function abrirSeletorMes(){
  const cur = getConfDate();
  pickerAno = cur.getFullYear();
  document.getElementById('mes-picker-overlay').style.display = 'flex';
  renderPickerGrid();
}

function fecharSeletorMes(e){
  if(!e || e.target === document.getElementById('mes-picker-overlay')){
    document.getElementById('mes-picker-overlay').style.display = 'none';
  }
}

function navAnoPicker(dir){
  pickerAno += dir;
  renderPickerGrid();
}

function renderPickerGrid(){
  document.getElementById('picker-ano').textContent = pickerAno;
  const now = new Date();
  const cur = getConfDate();
  const grid = document.getElementById('picker-meses-grid');
  grid.innerHTML = MESES_PT.map((m, i) => {
    const isSelected = pickerAno === cur.getFullYear() && i === cur.getMonth();
    const isCur = pickerAno === now.getFullYear() && i === now.getMonth();
    return `<button onclick="selecionarMesPicker(${i})" style="padding:10px 6px;border-radius:8px;cursor:pointer;font-family:'Inter',sans-serif;font-size:0.82rem;font-weight:500;transition:all .15s;background:${isSelected?'var(--gold)':isCur?'rgba(201,168,76,0.15)':'var(--bg4)'};border:1px solid ${isSelected?'var(--gold)':isCur?'var(--border)':'var(--border2)'};color:${isSelected?'#0A0A0F':'var(--text)'};">${m}</button>`;
  }).join('');
}

function selecionarMesPicker(mes){
  const now = new Date();
  confMesOffset = (pickerAno - now.getFullYear()) * 12 + mes - now.getMonth();
  document.getElementById('mes-picker-overlay').style.display = 'none';
  renderConferencia();
}

function updateStatus(id, val){
  const v = vendas.find(x=>String(x.id)===String(id));
  if(!v) return;
  v.status = val;
  patchVenda(id, {status:val}).catch(()=>toast('Erro ao salvar status.',true));
  renderConferencia(); renderTable();
}

function updateNota(id, val){
  const v = vendas.find(x=>String(x.id)===String(id));
  if(!v) return;
  v.nota = val;
  patchVenda(id, {nota:val}).catch(()=>toast('Erro ao salvar nota.',true));
}

function renderConferencia(){
  const mesRef = getConfDate();
  const mesLabel = mesRef.toLocaleString('pt-BR',{month:'long',year:'numeric'});
  document.getElementById('conf-mes-label').textContent = mesLabel.charAt(0).toUpperCase()+mesLabel.slice(1);

  // Filtro de busca por nome ou localizador
  const confQ = (document.getElementById('conf-search')?.value||'').toLowerCase().trim();

  // Coletar todas as parcelas que caem neste mÃªs, agrupadas por venda
  const confMes = [];
  vendas.forEach(v=>{
    // Aplicar filtro de busca
    if(confQ){
      const matchNome = v.cliente.toLowerCase().includes(confQ);
      const matchLoc  = (v.loc||'').toLowerCase().includes(confQ);
      if(!matchNome && !matchLoc) return;
    }
    const ps = parcelas(v).filter(p=>{
      return p.data.getMonth()===mesRef.getMonth() && p.data.getFullYear()===mesRef.getFullYear();
    });
    if(ps.length>0){
      confMes.push({ v, ps, total: ps.reduce((s,p)=>s+p.val,0) });
    }
  });

  // Stats do mÃªs
  const totalMes = confMes.reduce((s,c)=>s+c.total,0);
  const ativos = confMes.filter(c=>(c.v.status||'ativo')==='ativo');
  const inadimplentes = confMes.filter(c=>c.v.status==='inadimplente');
  const cancelados = confMes.filter(c=>c.v.status==='cancelado');
  const totalAtivo = ativos.reduce((s,c)=>s+c.total,0);
  const totalInad = inadimplentes.reduce((s,c)=>s+c.total,0);

  document.getElementById('conf-stats').innerHTML = `
    <div class="scard c-gold"><div class="sl">Total Previsto</div><div class="sv">${fmt(totalMes)}</div><div class="ss">${confMes.length} venda${confMes.length!==1?'s':''}</div><div class="sicon">ğŸ’°</div></div>
    <div class="scard c-green"><div class="sl">Ativos</div><div class="sv">${fmt(totalAtivo)}</div><div class="ss">${ativos.length} venda${ativos.length!==1?'s':''}</div><div class="sicon">âœ…</div></div>
    <div class="scard c-red"><div class="sl">Inadimplentes</div><div class="sv">${fmt(totalInad)}</div><div class="ss">${inadimplentes.length} venda${inadimplentes.length!==1?'s':''}</div><div class="sicon">âš ï¸</div></div>
    <div class="scard c-purple"><div class="sl">Cancelados</div><div class="sv">${cancelados.length}</div><div class="ss">sem comissÃ£o</div><div class="sicon">âœ–</div></div>
  `;

  const grid = document.getElementById('conf-cards-grid');
  const empty = document.getElementById('conf-empty');

  if(confMes.length===0){
    grid.innerHTML='';
    empty.style.display='block';
    return;
  }
  empty.style.display='none';

  // Ordenar: inadimplentes primeiro, depois ativos, depois cancelados
  confMes.sort((a,b)=>{
    const ord = {inadimplente:0, ativo:1, cancelado:2};
    return (ord[a.v.status||'ativo']||1) - (ord[b.v.status||'ativo']||1);
  });

  const fmtPag = {pix:'Pix',debito:'DÃ©bito',credito:'CrÃ©dito',boleto:'Boleto'};
  const fmtPagSaldo = {pix:'Pix/DÃ©bito',credito:'CrÃ©dito',boleto:'Boleto (Linear)'};

  grid.innerHTML = confMes.map(({v,ps,total})=>{
    const st = v.status || 'ativo';
    const stLabel = {ativo:'Ativo',inadimplente:'Inadimplente',cancelado:'Cancelado',pago:'Pago âœ“'}[st]||st;
    const stClass = {ativo:'s-ativo',inadimplente:'s-inadimplente',cancelado:'s-cancelado',pago:'fin-badge'}[st]||'s-ativo';
    const dataFmt = new Date(v.data+'T12:00:00').toLocaleDateString('pt-BR');
    const pctEnt = v.valor>0?(v.entrada||0)/v.valor:0;
    const pctStr = (pctEnt*100).toFixed(1)+'%';
    const pctColor = pctEnt>=0.06?'var(--green)':'var(--orange)';
    const nBol = (v.boletos||[]).filter(b=>b&&getBoletoData(b)).length;

    // Chips de recebimento: quando e quanto
    const psHtml = ps.map(p=>{
      const dtStr = p.data ? p.data.toLocaleDateString('pt-BR',{month:'short',year:'2-digit'}) : '';
      return `<div class="conf-row" style="color:var(--gold-l)">
        <span style="color:var(--text)">${p.label||'ComissÃ£o'}${dtStr?` <span style="color:var(--text3);font-size:0.7rem">â†’ ${dtStr}</span>`:''}</span>
        <span style="font-weight:700">${fmt(p.val)}</span>
      </div>`;
    }).join('');

    // Badge forma entrada
    const feLabel = v.formaEntrada ? fmtPag[v.formaEntrada]||v.formaEntrada : 'â€”';
    const feColors = {pix:'var(--green)',debito:'var(--blue)',credito:'var(--purple)',boleto:'var(--orange)'};
    const feColor = feColors[v.formaEntrada]||'var(--text2)';

    // Forma pagamento saldo
    const pagLabel = fmtPagSaldo[v.pag]||v.pag;

    // Nota salva
    const notaVal = (v.nota||'').replace(/"/g,'&quot;');

    return `<div class="conf-card st-${st}" id="cc-${v.id}">
      <div class="conf-card-header">
        <div>
          <div class="conf-cliente">${v.cliente}</div>
          <div class="conf-emp">${v.emp}</div>
          <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap;align-items:center;">
            <span class="s-badge ${stClass}">${stLabel}</span>
            ${v.pag==='boleto'?`<span style="color:${pctColor};font-size:0.7rem;font-weight:600">${pctStr} ent.</span>`:''}
          </div>
        </div>
        <div>
          <div class="conf-com">${fmt(total)}</div>
          <div class="conf-com-label">comissÃ£o</div>
        </div>
      </div>

      <hr class="conf-divider">

      <div class="conf-row"><span>Data da Venda</span><span>${dataFmt}</span></div>
      ${(()=>{
        const entradaPaga = v.entrada||0;
        const valorTotal  = v.valor||0;
        const entradaEsperada = valorTotal * 0.10; // 10% como referÃªncia
        const falta = Math.max(0, entradaEsperada - entradaPaga);
        if(entradaPaga > 0 && falta > 0.01){
          return `<div class="conf-row"><span>Valor da Entrada</span><span style="color:var(--green);font-weight:600">${fmt(entradaPaga)}</span></div>
          <div class="conf-row"><span>Saldo da Entrada</span><span style="color:var(--orange);font-weight:600">${fmt(falta)} a receber</span></div>`;
        } else if(entradaPaga > 0){
          return `<div class="conf-row"><span>Valor da Entrada</span><span style="color:var(--green);font-weight:600">${fmt(entradaPaga)} âœ“</span></div>`;
        }
        return `<div class="conf-row"><span>Valor da Entrada</span><span style="color:var(--orange);font-weight:600">NÃ£o informado</span></div>`;
      })()}
      ${nBol>0 && descricaoBoletos(v) ? `<div class="conf-row"><span>ComposiÃ§Ã£o</span><span style="color:var(--gold-l);font-size:0.78rem;font-weight:600">${descricaoBoletos(v)}</span></div>` : ''}
      <div class="conf-row"><span>Liner</span><span>${v.liner}</span></div>
      <div class="conf-row"><span>Localizador</span><span style="color:var(--text2);font-size:0.75rem">${v.loc||'â€”'}</span></div>

      <hr class="conf-divider">

      ${psHtml}

      <div class="status-select-wrap">
        <label>Status:</label>
        <select class="status-sel" onchange="updateStatus('${v.id}',this.value)">
          <option value="ativo" ${st==='ativo'?'selected':''}>âœ… Ativo</option>
          <option value="inadimplente" ${st==='inadimplente'?'selected':''}>âš ï¸ Inadimplente</option>
          <option value="cancelado" ${st==='cancelado'?'selected':''}>âœ– Cancelado</option>
          <option value="pago" ${st==='pago'?'selected':''}>ğŸ† Pago Integralmente</option>
        </select>
      </div>
      <textarea class="conf-nota" rows="2" placeholder="ObservaÃ§Ã£o..." onblur="updateNota('${v.id}',this.value)">${v.nota||''}</textarea>
    </div>`;
  }).join('');
}

// â•â• COMISSÃ•ES FINALIZADAS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFinalizadas(){
  const finalizadas = vendas.filter(v=>(v.status||'ativo')==='pago');
  const grid = document.getElementById('fin-cards-grid');
  const empty = document.getElementById('fin-empty');
  const stats = document.getElementById('fin-stats');
  if(!grid) return;

  const totalFin = finalizadas.reduce((s,v)=>s+parcelas(v).reduce((a,p)=>a+p.val,0),0);
  const volFin = finalizadas.reduce((s,v)=>s+v.valor,0);

  if(stats) stats.innerHTML = `
    <div class="scard c-green"><div class="sl">ComissÃµes Recebidas</div><div class="sv">${fmt(totalFin)}</div><div class="ss">${finalizadas.length} venda${finalizadas.length!==1?'s':''}</div><div class="sicon">ğŸ†</div></div>
    <div class="scard c-gold"><div class="sl">Volume Finalizado</div><div class="sv">${fmt(volFin)}</div><div class="ss">valor bruto</div><div class="sicon">ğŸ’</div></div>
  `;

  if(finalizadas.length===0){
    grid.innerHTML='';
    if(empty) empty.style.display='block';
    return;
  }
  if(empty) empty.style.display='none';

  grid.innerHTML = finalizadas.map(v=>{
    const dataFmt = new Date(v.data+'T12:00:00').toLocaleDateString('pt-BR');
    const comTotal = parcelas(v).reduce((s,p)=>s+p.val,0);
    const nBol = (v.boletos||[]).filter(b=>b&&(typeof b==='string'?b:b.data)).length;
    return `<div class="fin-card">
      <div class="conf-card-header">
        <div>
          <div class="conf-cliente">${v.cliente}</div>
          <div class="conf-emp">${v.emp}</div>
          <div style="margin-top:6px"><span class="fin-badge">ğŸ† Pago Integralmente</span></div>
        </div>
        <div>
          <div class="conf-com">${fmt(comTotal)}</div>
          <div class="conf-com-label">recebido</div>
        </div>
      </div>
      <hr class="conf-divider">
      <div class="conf-row"><span>Data da Venda</span><span>${dataFmt}</span></div>
      <div class="conf-row"><span>Valor da Venda</span><span>${fmt(v.valor)}</span></div>
      <div class="conf-row"><span>Liner</span><span>${v.liner}</span></div>
      <div class="conf-row"><span>Localizador</span><span style="color:var(--text2);font-size:0.75rem">${v.loc||'â€”'}</span></div>
      ${v.nota?`<div style="font-size:0.75rem;color:var(--text2);margin-top:8px;padding:8px;background:var(--bg3);border-radius:6px;">${v.nota}</div>`:''}
      <div style="margin-top:12px;display:flex;gap:8px;">
        <button onclick="reverterStatus('${v.id}')" style="background:none;border:1px solid rgba(224,104,88,0.2);border-radius:6px;color:var(--red);padding:5px 12px;cursor:pointer;font-size:0.75rem;font-family:'Inter',sans-serif;transition:all .15s;" onmouseover="this.style.background='rgba(224,104,88,0.12)'" onmouseout="this.style.background='none'">â†© Reverter para Ativo</button>
      </div>
    </div>`;
  }).join('');
}

function reverterStatus(id){
  const v = vendas.find(x=>String(x.id)===String(id));
  if(!v) return;
  v.status='ativo';
  patchVenda(id,{status:'ativo'}).catch(()=>toast('Erro ao salvar.',true));
  renderAll();
  toast('â†© Status revertido para Ativo');
}

// â•â• EDIT VENDA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let editId = null;

function openEdit(id){
  const v = vendas.find(x=>String(x.id)===String(id));
  if(!v) return;
  editId = String(id);
  document.getElementById('e-data').value = v.data||'';
  document.getElementById('e-cliente').value = v.cliente||'';
  document.getElementById('e-loc').value = v.loc||'';
  document.getElementById('e-liner').value = v.liner||'';
  document.getElementById('e-emp').value = v.emp||'';
  document.getElementById('e-valor').value = v.valor||'';
  document.getElementById('e-entrada').value = v.entrada||'';
  document.getElementById('e-forma-entrada').value = v.formaEntrada||'';
  document.getElementById('e-pag').value = v.pag||'';
  document.getElementById('e-parc').value = v.parc||1;
  onEditPagChange();
  const boletos = (v.boletos||[]).filter(b=>b&&(typeof b==='string'?b:b.data));
  const nBol = boletos.length||1;
  document.getElementById('e-nboletos').value = nBol;
  gerarCamposBoletoEdit();
  boletos.forEach((b,i)=>{
    const inp = document.getElementById(`e-bol-${i}`);
    const inpV = document.getElementById(`e-bol-v-${i}`);
    if(inp) inp.value = getBoletoData(b);
    if(inpV) inpV.value = getBoletoValor(b, '');
  });
  document.getElementById('edit-overlay').classList.add('show');
}

function closeEdit(){
  editId = null;
  document.getElementById('edit-overlay').classList.remove('show');
}

function onEditPagChange(){
  const p = document.getElementById('e-pag').value;
  document.getElementById('ef-parc').classList.toggle('hidden', p!=='credito');
  document.getElementById('ef-nboletos').classList.toggle('hidden', p!=='boleto');
  if(p==='boleto') gerarCamposBoletoEdit();
  else document.getElementById('ef-boletos-datas').style.display='none';
}

function onEditValorChange(){
  // just update visual feedback if needed
}

function gerarCamposBoletoEdit(){
  const n = parseInt(document.getElementById('e-nboletos').value)||1;
  const grid = document.getElementById('e-boletos-grid');
  const wrap = document.getElementById('ef-boletos-datas');
  wrap.style.display='block';
  grid.innerHTML = Array.from({length:n},(_,i)=>`
    <div class="field">
      <label>Boleto ${i+1} â€” Vencimento</label>
      <input type="date" id="e-bol-${i}">
      <input type="number" id="e-bol-v-${i}" placeholder="Valor do boleto (R$)" min="0" step="0.01" style="margin-top:6px;background:var(--bg3);border:1px solid rgba(255,255,255,0.08);border-radius:var(--r3);padding:9px 12px;color:var(--text);font-family:'Inter',sans-serif;font-size:0.82rem;outline:none;width:100%;transition:border-color .2s;" onfocus="this.style.borderColor='var(--gold)'" onblur="this.style.borderColor='rgba(255,255,255,0.08)'">
    </div>`).join('');
}

async function saveEdit(){
  if(!editId) return;
  const v = vendas.find(x=>String(x.id)===editId);
  if(!v) return;
  v.data = document.getElementById('e-data').value;
  v.cliente = document.getElementById('e-cliente').value.trim();
  v.loc = document.getElementById('e-loc').value.trim();
  v.liner = document.getElementById('e-liner').value.trim();
  v.emp = document.getElementById('e-emp').value;
  v.valor = parseFloat(document.getElementById('e-valor').value)||0;
  v.entrada = parseFloat(document.getElementById('e-entrada').value)||0;
  v.formaEntrada = document.getElementById('e-forma-entrada').value;
  v.pag = document.getElementById('e-pag').value;
  v.parc = parseInt(document.getElementById('e-parc').value)||1;
  if(v.pag==='boleto'){
    const n = parseInt(document.getElementById('e-nboletos').value)||1;
    v.boletos = Array.from({length:n},(_,i)=>{
      const dt = document.getElementById(`e-bol-${i}`)?.value||'';
      const val = parseFloat(document.getElementById(`e-bol-v-${i}`)?.value)||0;
      return dt ? {data:dt, valor:val} : null;
    }).filter(Boolean);
  }
  const btnSave = document.querySelector('#edit-overlay .btn-reg');
  if(btnSave){ btnSave.disabled=true; btnSave.textContent='Salvando...'; }
  try{
    await patchVenda(editId, vendaToRow(v));
    closeEdit();
    renderAll();
    toast('âœ“ Venda atualizada!');
  }catch(e){
    toast('Erro ao salvar: '+e.message,true);
  }
  if(btnSave){ btnSave.disabled=false; btnSave.textContent='ğŸ’¾ Salvar AlteraÃ§Ãµes'; }
}

// â•â• CONFIG SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showConfig(){ document.getElementById('config-overlay').classList.add('show'); }
function hideConfig(){ document.getElementById('config-overlay').classList.remove('show'); }

function saveConfig(){
  const url = document.getElementById('cfg-url').value.trim().replace(/\/$/, '');
  const key = document.getElementById('cfg-key').value.trim();
  if(!url||!key){ alert('Preencha os dois campos!'); return; }
  SUPA_URL = url; SUPA_KEY = key;
  localStorage.setItem('supa_url', url);
  localStorage.setItem('supa_key', key);
  bootApp();
}

async function bootApp(){
  document.getElementById('boot-msg').style.display='flex';
  await loadVendas();
  document.getElementById('boot-msg').style.display='none';
  if(!dbOk && (!SUPA_URL||!SUPA_KEY)){
    showConfig();
  } else if(dbOk){
    renderAll();
  }
}

// â•â• INIT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
bootApp();
</script>
</body>
</html>
